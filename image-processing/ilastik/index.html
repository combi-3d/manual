
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Manual of CoMBI">
      
      
      
        <meta name="author" content="Tajika Y.">
      
      
      <link rel="shortcut icon" href="../../img/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.4">
    
    
      
        <title>Segmentation by ilastik - Manual of CoMBI</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.15aa0b43.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.75751829.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7C&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#segmentation-by-ilastik" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="Manual of CoMBI" class="md-header-nav__button md-logo" aria-label="Manual of CoMBI">
      
  <img src="../../img/logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            Manual of CoMBI
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Segmentation by ilastik
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Manual of CoMBI" class="md-nav__button md-logo" aria-label="Manual of CoMBI">
      
  <img src="../../img/logo.png" alt="logo">

    </a>
    Manual of CoMBI
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      



  <li class="md-nav__item">
    <a href="../../index.html" class="md-nav__link">
      Top page
    </a>
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" data-md-state="indeterminate" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Installation/導入
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Installation/導入" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        Installation/導入
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../../devices/system/index.html" class="md-nav__link">
      System Overview/概要
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../devices/camera/index.html" class="md-nav__link">
      Imaging devices/カメラなど
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../devices/selfmade/index.html" class="md-nav__link">
      Self-made devices/自作装置
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../devices/computer/index.html" class="md-nav__link">
      Computer and storage/コンピュータとストレージ
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../devices/application/index.html" class="md-nav__link">
      Applications/アプリケーション
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" data-md-state="indeterminate" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Instruction/操作
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Instruction/操作" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Instruction/操作
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../../operation/frozenblock/index.html" class="md-nav__link">
      Frozen Block
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../operation/paraffinblock/index.html" class="md-nav__link">
      Paraffin Block
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../operation/camerasettings/index.html" class="md-nav__link">
      Camera Settings
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../operation/tethering/index.html" class="md-nav__link">
      Tethering (optional)
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../operation/combi-u/index.html" class="md-nav__link">
      CoMBI-U (Universal)
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../operation/combi-c/index.html" class="md-nav__link">
      CoMBI-C (Cryostat)
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../operation/combi-s/index.html" class="md-nav__link">
      CoMBI-S (Sliding, motorized)
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../operation/combi-s-m/index.html" class="md-nav__link">
      CoMBI-S (Sliding, manual)
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../operation/combi-r/index.html" class="md-nav__link">
      CoMBI-R (Rotary, manual)
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" data-md-state="indeterminate" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Image Processing
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Image Processing" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        Image Processing
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../introduction/index.html" class="md-nav__link">
      Overview/画像処理の概要
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../rawjpeg/index.html" class="md-nav__link">
      RAW to JPEG conversion/RAW現像
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../scale/index.html" class="md-nav__link">
      Resize/画像の縮小
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../registration/index.html" class="md-nav__link">
      Image Registration/ズレ補正
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../3dslicer/index.html" class="md-nav__link">
      3D Reconstruction, 3D slicer
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../icy/index.html" class="md-nav__link">
      3D Reconstruction, Icy
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../horos/index.html" class="md-nav__link">
      3D Reconstruction, Horos/OsiriX
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../correlation/index.html" class="md-nav__link">
      Correlation of 2D and 3D images/3D像に切片位置を示す
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../EDF/index.html" class="md-nav__link">
      Extended Depth of Field/深度合成
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="index.html" class="md-nav__link">
      Segmentation by ilastik/セグメンテーション
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../../gallery/gallery/index.html" class="md-nav__link">
      Gallery/作品集
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../../publication/publication/index.html" class="md-nav__link">
      Publications/論文
    </a>
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" data-md-state="indeterminate" type="checkbox" id="nav-7" checked>
    
    <label class="md-nav__link" for="nav-7">
      Electronics
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Electronics" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        <span class="md-nav__icon md-icon"></span>
        Electronics
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../../electronics/ATmega328P/index.html" class="md-nav__link">
      ATmega328P standalone/単体利用
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../electronics/terminal/index.html" class="md-nav__link">
      Crimped terminal/圧着端子
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../electronics/vender/index.html" class="md-nav__link">
      Venders/パーツの入手先
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#precedure" class="md-nav__link">
    Precedure
  </a>
  
    <nav class="md-nav" aria-label="Precedure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-new-projectpixel-classification" class="md-nav__link">
    Create New Projectより、Pixel Classification
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-input-data" class="md-nav__link">
    「1. Input Data」
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-feature-selection" class="md-nav__link">
    「2. Feature selection」
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-training" class="md-nav__link">
    「3. Training」
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-prediction-export" class="md-nav__link">
    「4. Prediction Export」
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-batch-processing" class="md-nav__link">
    「5. Batch Processing」
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    ファイル・フォルダを整理する
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#imagejfijiphotoshop010255" class="md-nav__link">
    ImageJ/FIJIまたはPhotoshopで、二値化画像を0,1から0,255にする
  </a>
  
    <nav class="md-nav" aria-label="ImageJ/FIJIまたはPhotoshopで、二値化画像を0,1から0,255にする">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#imagejfiji" class="md-nav__link">
    ImageJ/FIJIの場合
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#photoshop" class="md-nav__link">
    Photoshopの場合
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3d-slicer" class="md-nav__link">
    3D slicerで再構築
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tips" class="md-nav__link">
    Tips
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="segmentation-by-ilastik">Segmentation by ilastik</h1>
<p>ilastik is an application for segmentation by machine learning (Nature Methods, 2019). It is designed so that biologists can operate without any knowledge of machine learning. For installation, visit developer's site <a href="https://www.ilastik.org/">https://www.ilastik.org</a>. It seems to be suitable for segmentation of specific structures (regions of interest) in full-color blockface images obtained by CoMBI. Here is a simple procedure written in Japanese, to do "Choosing normal area and damaged area in a certain organ". There is a detailed documentation in English in the official site (<a href="https://www.ilastik.org/documentation/index.html">Documentation</a>).</p>
<p><span style="color:#444C99;">ilastikは、セグメンテーションを機械学習で行うアプリです（Nature Methods, 2019）。機械学習の知識がなくても、操作できるようにデザインされています。<a href="https://www.ilastik.org/">https://www.ilastik.org</a>からダウンロードしてインストールします。CoMBIで撮影したフルカラーのブロック面画像で特定の構造物（関心領域）をSegmentationするのに良さそうです。「とある臓器に正常部位と傷害部位がある。正常部位だけSegmentationしたい」、これをお題に、手順を記します。日本語の簡単な手順書です。本家のサイトには詳しい英語説明ページ（<a href="https://www.ilastik.org/documentation/index.html">Documentation</a>）があります。</span></p>
<hr />
<h2 id="precedure">Precedure</h2>
<h3 id="create-new-projectpixel-classification">Create New Projectより、<code>Pixel Classification</code></h3>
<ul>
<li>プロジェクトファイル、拡張子ilpとして保存する。</li>
<li>この後は、右のカラムの1番から5番に従って進めます。</li>
</ul>
<h3 id="1-input-data">「1. Input Data」</h3>
<ul>
<li>学習させるための画像を開く。CoMBIの連続画像のうち、標本全体や実験群全体を代表するような数枚を選ぶ。2〜4枚で行った。<code>Drag and Drop</code> または、プルダウンメニュー<code>Add New</code>&gt; <code>Add separate image(s)</code></li>
</ul>
<h3 id="2-feature-selection">「2. Feature selection」</h3>
<ul>
<li>全部にチェックするので良いが、マシンパワー（おもにCPU）による。色と明るさ、輪郭線、テクスチャ（模様、行列）を計算してくれるらしい。</li>
<li>「Core i9, HBM2-2GB, メモリ32GB」では全部チェックした。「Core i5, 内蔵グラフィクス、メモリ8GB」では、チェック項目を減らした。σとびとびで半分にチェック。シグマは、認識させたい構造物が小さいか大きいかを決める設定値。</li>
<li>（左カラム下方に、各種フィルタがかかった画像リストがでてくる。クリックすると画像を確認できる。）</li>
<li>（最初は、どうすればいいのかさっぱり分からない作業です。とりあえず、飛ばし飛ばしで半数にチェックするくらいで進めてください。次のステップ「3. Training」において、推奨チェックを自動で探してくれるオプションがあります。）</li>
</ul>
<h3 id="3-training">「3. Training」</h3>
<ul>
<li>Label1, Label2の二種類に塗り分けてみる。（デフォルトは2種類。追加して多種類できるがマシンパワーが必要）</li>
<li>選び出したい領域を、Label1の黄色いペンで印をいれる。（例：正常部位。ペンの太さは、1〜7くらいで動作が軽い。太くなると計算時間が長くなる。）</li>
<li>それ以外の領域をLabel2青いペンで印を入れる。（例：傷害部位＋背景。）</li>
<li>完全に塗りつぶす必要はないが、丁寧に印を入れれば入れるほど、結果が良くなる。</li>
<li><code>Live Update</code>で結果を様子見しながら、作業できる。ただし、Liveオンのままでは、動作が鈍くなりがちです。</li>
<li>オプション：Label1などの名称は、変更できます。</li>
<li>メモ：Label1, Lable２などは、事項「4. Prediction Export」では、Channel1, Channel2などと呼ばれ、表記は「c」となります。複数のChannelをTIFFやHDFにすると、FIJIで開いたとき、Channel1, 2...となります。</li>
<li>オプション：ボタン<code>Suggest Features</code>について。前項「2. Feature Selection」を3通り評価してくれる。いったん、Live OFFにして、ボタン<code>Suggest Features</code>で別ウィンドウが開く。 <code>Filter Method (recommended)</code>, Number of Feartures <code>0</code> (=auto), <code>Run Feature Selection</code>。しばらく待つ、けっこう待つ。プルダウンから、「自身で選んだチェック、自動チェック、全チェック」の3通りを比較/選択できる。自身のチェック以外を選び直したいときは、下段のボタン<code>Select Feature Set</code>を押す。上記では、Number of Featuresが、0=自動チェックの例だったが、ここで1-10のどれかを入力すると、例えば、3を入力するとsize 3通りなどを試してくれる。（Set Size Penaltyは、いじっていない、デフォルトの0.1。）　セグメンテーションの正確さと計算時間との兼ね合い、落としどころを見つける。このオブションはやらなくても進められる。</li>
</ul>
<h3 id="4-prediction-export">「4. Prediction Export」</h3>
<ul>
<li>Source: デフォルトは<code>Probability</code>で、グレースケール画像になる。<code>Simple Segmentation</code>は、白黒ハッキリした画像（二値化、2階調、1 bitの画像）になる。</li>
<li>ボタン<code>Choose Export Image Settings</code>より、<ul>
<li>yxc: Label1だけ指定してExportするには、「c」のチェックを外して、start 0, stop 1にする。Label2指定なら、1,2とする。（ただし、このLabel指定はProbabilityでのみ有効。Simple Segmentatinでは効かない。バグ？macOS12, ilastik1_4_0b。「c」のチェックをONにすると、出力結果が不安定だった。3-labelsで検証したとき、ProbabilityではRGBになり、Simple Segmentationでは0,1,2になった。別の日には、Channelに入ったこともあった。Channelになると、PhotoshopではLayerになったり、開けなかったりする。）</li>
<li>Transformation, Convert to Data Type: <code>unsigned 8-bit</code>。TIFFで普通の階調数。16bitなどへ増やせるけど、Segmentationデータなので必要ないと思います。</li>
<li>Transformation, Renormalize...: Probabilityでは、チェックONが必須（OFFにすると二値化するため）。Simple Segmentationでは、チェックOFFが必須（ONにすると真っ白になったり、ただ効かなかったりする。あとでPhotoshopかImageJ/FIJIで変換する。）</li>
<li>Output File Info, Format: <code>tif</code>または<code>tiff</code>がよいでしょう。たぶんJPEGでは境界がへんになりそうです。</li>
<li>File: では、保存先を指定する。デフォルトの<code>{dataset_dir}/{nickname}_{result_type}.tif</code>を入力すると、出力<code>Export</code>されるファイルは、「同じフォルダに保存され、同じファイル名プラス_Simple Segmentation.tif」などになる。もし、別のフォルダを指定したい場合、ボタン<code>Select...</code>より、フォルダを指定し、<code>slash</code>の後に、デフォルトのファイル名様式<code>{nickname}_{result_type}.tif</code>を入力します。アドレス指定後に、デフォルトのファイル名様式は全部消えてしまうので、改めてファイル名様式を手入力する必要があります。</li>
<li>CoMBIの大量の連続画像に同一のセグメンテーション処理を施す場合は、ここの<code>Export</code>は使用しません。次の項目「5. Batch Processing」へ進んでください。</li>
<li>Trainingに使用した数枚の画像だけで、セグメンテーション画像が欲しい場合：　上カラムの<code>Export</code>ボタンまたは左の<code>Export All</code>ボタンを押すと、セグメンテーション画像を保存できます。</li>
</ul>
</li>
</ul>
<p><img alt="Export Settings" src="../img/ilastik_export.png" title="Export" /> </p>
<p><em>Export Settings, Default (left) settings and settings for Simple Segmentation, TIFF, Unsigned 8bit, and Select folder (right).</em></p>
<h3 id="5-batch-processing">「5. Batch Processing」</h3>
<ul>
<li><code>Select RAW Data Files</code>より、連続画像を選ぶ。Shiftを押しながら、複数画像を選択する。</li>
<li>左カラムのボタン、<code>Process all files</code>。しばらく待つ。結構時間が掛かる。数百枚で行おうとしたとき、途中でフリーズしたし、変換されない画像があったり（抜け落ちたり）もした。マシンパワーに自信がなければ、少しずつ（100枚ずつなど）やってみるとうまくいく。<ul>
<li>Simple Segmentationの場合、出力されたtifファイルは、一見真っ黒である。一般の画像8bitでは、ピクセルは輝度0-255を持つ。Simple Segmentationでは、二値化され（Renormalizeされなかった）画像は、0と1になっている。8bitで表記すると、00000000と00000001になっている。それぞれ、Training時のデフォルトLabelsのうち、Label1-黄色と、Label2-青色である。ImageJ/FIJIで開いて、カーソル位置の値をみると、Value1とValue2だけで構成された画像であることが確認できる。Finderで表示されるアイコンは真っ黒画像になるのでビックリするが、アイコンはそれでよい。のちに0,1を0,255に変換できる（下記）。</li>
<li><code>Export Image Settings</code>で設定した条件はプロジェクトファイル（.ilp）には保存されないことがある。もし、「5. Batch Processing」を、別の日、別のパソコンで実行する場合は、設定を確認すること（macOS 11, ilastik 1.4.0b, 正式対応していないバージョンのせいか？）。</li>
</ul>
</li>
</ul>
<hr />
<h2 id="_1">ファイル・フォルダを整理する</h2>
<ul>
<li>（別フォルダにExportしたなら、この作業は必要ありません。）</li>
<li>MacならFinderで、リスト表示<code>as List</code></li>
<li>ファイルの種類<code>Kind</code>で並べ替えると、元画像（例 .jpeｇ）と、二値化した画像（例 ..._Simple Segmentation.tif）が分かれて並ぶ。</li>
<li>二値化画像（.tif）だけ選んで、新しいフォルダに収める。</li>
</ul>
<h2 id="imagejfijiphotoshop010255">ImageJ/FIJIまたはPhotoshopで、二値化画像を0,1から0,255にする</h2>
<p>0, 255にしておくと、3D slicerで、3D再構築しやすいため。</p>
<h3 id="imagejfiji">ImageJ/FIJIの場合</h3>
<ul>
<li><code>Image</code>&gt; <code>Adjust</code>&gt; <code>Threshold...</code>　（この作業は安定しない、数値入力ではじかれたり。下記のどれかうまくいくやつを探してください）<ul>
<li><code>Dark Background</code>にチェックして、数値は<code>2, 255</code>。選択部位が白、背景が黒</li>
<li>（チェックなしで、数値を、<code>0, 1</code>とすると、選択部位が黒、背景白になり、反転した画像になる）</li>
<li>（チェックなしで、<code>1, 1</code>なら、選択部位が白、背景が黒）</li>
<li>（<code>Set</code>を押して数値を入力し、確定させたらうまくいったことがある。）</li>
<li>（スライダーを動かしてから、数値入力したら、うまくいったことがある。）</li>
</ul>
</li>
<li><code>Apply</code>をおして、適用する。Method:Default, Background: Dark, Check on Calculate th..., Uncheck others.</li>
<li>一枚だけ変換したい場合は、ここで<code>Save as</code>（うまくいけば、まっ黒にしか見えなかった画像・アイコンが、白黒画像・白黒アイコンになります。）</li>
<li>連続画像を変換したい場合は、<code>Threshold</code>から<code>Apply</code>までを、Macroに記録し、Batch処理する）</li>
</ul>
<h3 id="photoshop">Photoshopの場合</h3>
<ul>
<li><code>Image</code>&gt; <code>Adjustments</code>&gt; <code>Threshold</code></li>
<li>指定する数値は、<code>2</code></li>
<li><code>Image</code>&gt; <code>Adjustments</code>&gt; <code>Invert</code>（黒バックになる。3D再構築用に）</li>
<li>（ActionとBatchを使って連続画像を処理する。）</li>
</ul>
<h2 id="3d-slicer">3D slicerで再構築</h2>
<ul>
<li><code>Load</code>して</li>
<li>オプション: <code>Segmentation</code>（Threshold）して</li>
<li><code>Volume Rendering</code>で、3D画像を再構築する。</li>
<li>（Simple Segmentationを0,1のまま3D slicerにいれてみたけど、Volume renderingでは色の調節ができませんでした。0-255への変換を経たほうがいいようです。）</li>
</ul>
<hr />
<h2 id="tips">Tips</h2>
<p>2021-8-26</p>
<ul>
<li>Live Updateの動作が重い、500x700（20um/pix)を3-4枚。350x350に切り抜いて、Featureを3.5と5だけにしたらやっと動いた。おそらく、認識させたい構造が複雑になる（パターンが複雑、似ているけど異なる構造があるなど）。また、マークする筆を太くすると、動作が鈍くなる。単純なマシンパワー不足だけではなく、画像とSegmentation対象の性質にもよると思う。</li>
<li>どうやら2回（2プロジェクト、.ilp）は行うのがいいようだ。<strong>1回目</strong>：連続画像を代表するような数枚を、適当に選んで、Segmentationする。Export, Simple Segmentationを行い、画像を確認すると、かならず失敗作が含まれる。次に、<strong>2回目</strong>：失敗作だけをつかってSegmentationを行う。その結果、すべての連続切片でおおむねSegmentationが成功している。場合によっては、<strong>3回目</strong>：同様に。3回目でうまくいったことがある。</li>
<li>学習させる画像は、3枚までが限度か。使っているのは、Core i7 4.2 GHz 4-cores、HT対応（iMac 2017）。もっとコア数があればいいのかもしれない。</li>
</ul>
<p>2021-12-10</p>
<ul>
<li>スムースに動いた。200x300pixelsの画像、1100枚の中から5枚選んでSegmentationし、1100枚にBatch。初めに3枚で行ったらキレイではなく、次に5枚にしたら成功した。MacBookPro2018 Core i9 6-cores。</li>
<li>Featureでは、Colorを重視し、EdgeとTextureは少なめに選択するなど、目的に合わせると同時に動作を軽くした。</li>
<li>3D slicerで表示するとき、Segmentation by iLastikは200x300を使用し、MPRやVRは400x600などの高画質を使用した。解像度が異なっても、XYZサイズを入力すれば正確に重ねられる。iLastik作業を軽くすると同時に、VR, MPRは高画質で示せた。</li>
</ul>
<p>2022-2-25　（下記のうちTIFFの症状は再現できず。2022-2-28、下記）</p>
<ul>
<li>「4. Prediction Export」で、Probabilityを出力した。Simple Segmentation（二値化した画像）とは異なり、グラデーションのあるグレースケール画像になる。画像形式では、tifかHDF5にする。</li>
<li>のちにPhotoshopを使う場合は、tifで、FIJIで開く場合はHDF5。</li>
<li>Convertでは、sign-8bit (0-255), sign-16bit (0-65535), unsign-16bit (-32768 - +32768), floating-32bitいろいろある。</li>
<li>Photoshop用のtifなら、floating-32bitを選ぶ。もしくは、チェックしない（デフォルトでfloating32bitになる）。Photoshopで開くと、レイヤーとしてProbabilityの像が表示される。ふつうの画像にする場合は、Layer&gt;Flatten。（floating-32bit以外を選ぶと、空っぽの画像ファイルになり、Photoshopでは、なんにもなしのレイヤーができるだけ。）</li>
<li>FIJI用のHDF5なら、チェックなし（デフォルトのfloating-32bit）。</li>
<li>FIJIでHDF5を開く前に、iLastik提供のプラグインが必要。
    Help&gt; ImageJ Updater
    Manage update sites、iLastikを選ぶ
    ImageJ Updaterウィンドウで、ボタンAdvanced Modeを押す。
        プルダウン、View uninstalled files onlyを選ぶと、plugins/ilastik4ij.jarがみえる。
        または、Searchでilastik。
    ボタンinstall, ボタンApply Change
    FIJIを再起動</li>
<li>FIJIでplug-in&gt; ilastik&gt; Import HDF5　より、画像を選んで開く。
    反転画像もあって、2枚として開いている。
    普通の画像に変換するには、まず、8bitに変換、TIFFででも保存。
    ただし、Save as TIFFからは、最初の一枚しか保存できない。白バックにグレーのProbabilityのみ。表示を変えていてもだめ。それで良ければ良い。もし、白バックも黒バック（反転像）も直接保存したい場合は、Save as Image Sequenceから、TIFFへ。末尾に01, 02がついて、2枚の画像が書き出される。</li>
</ul>
<p>2021-2-28　上記の症状は再現できないが、TIFFでできることが分かった</p>
<ul>
<li>Label1,2...が、Channel1,2...となることに気づいた。</li>
<li>Probabilityの場合。Exportで、Label (Channel)をひとつだけ指定できた。0,1を0,255へ変換できた。Channelを複数を指定すると適当な着色がなされる、Label3種はR,G,Bになった。</li>
<li>Simple Segmentationの場合。バグか。Exportで、Label(Channel)を指定できない。Renormal（0,1を0,255へ変換）できない、真っ白一辺倒の画像ができてしまう場合がある。できたのは、Label(Channel)指定しない（チェックON）、かつRenormalしない（チェックOFF）とき、Label2種から0,1へ、Label3種から0,1,2へExportできた。</li>
<li>いろいろTIFFでやってみて、PhotoshopでもFIJIでも素直に開けた。（Channelに入るという症状がなかった）</li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            © 2021 Tajika Y, CC BY-NC
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.93c04032.min.js"></script>
      <script src="../../assets/javascripts/bundle.83e5331e.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: ['navigation.expand'],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>