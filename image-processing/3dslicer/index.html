
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Manual of CoMBI">
      
      
        <meta name="author" content="Tajika Y.">
      
      
      <link rel="icon" href="../../img/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.9">
    
    
      
        <title>3D slicer （Win, Mac, Linux） - Manual of CoMBI</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.120efc48.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.9647289d.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#3d-slicer-win-mac-linux" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Manual of CoMBI" class="md-header__button md-logo" aria-label="Manual of CoMBI" data-md-component="logo">
      
  <img src="../../img/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Manual of CoMBI
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              3D slicer （Win, Mac, Linux）
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Manual of CoMBI" class="md-nav__button md-logo" aria-label="Manual of CoMBI" data-md-component="logo">
      
  <img src="../../img/logo.png" alt="logo">

    </a>
    Manual of CoMBI
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../index.html" class="md-nav__link">
        Top page
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" data-md-state="indeterminate" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Installation/導入
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Installation/導入" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Installation/導入
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../devices/system/index.html" class="md-nav__link">
        System Overview/概要
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../devices/camera/index.html" class="md-nav__link">
        Imaging devices/カメラなど
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../devices/selfmade/index.html" class="md-nav__link">
        Self-made devices/自作装置
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../devices/computer/index.html" class="md-nav__link">
        Computer and storage/コンピュータとストレージ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../devices/application/index.html" class="md-nav__link">
        Applications/アプリケーション
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" data-md-state="indeterminate" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Instruction/操作
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Instruction/操作" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Instruction/操作
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../operation/frozenblock/index.html" class="md-nav__link">
        Frozen Block
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../operation/paraffinblock/index.html" class="md-nav__link">
        Paraffin Block
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../operation/camerasettings/index.html" class="md-nav__link">
        Camera Settings
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../operation/tethering/index.html" class="md-nav__link">
        Tethering (optional)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../operation/combi-u/index.html" class="md-nav__link">
        CoMBI-U (Universal)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../operation/combi-c/index.html" class="md-nav__link">
        CoMBI-C (Cryostat)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../operation/combi-s/index.html" class="md-nav__link">
        CoMBI-S (Sliding, motorized)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../operation/combi-s-m/index.html" class="md-nav__link">
        CoMBI-S (Sliding, manual)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../operation/combi-r/index.html" class="md-nav__link">
        CoMBI-R (Rotary, manual)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" data-md-state="indeterminate" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Image Processing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Image Processing" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Image Processing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../introduction/index.html" class="md-nav__link">
        Overview/画像処理の概要
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../rawjpeg/index.html" class="md-nav__link">
        RAW to JPEG conversion/RAW現像
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../scale/index.html" class="md-nav__link">
        Resizing and Reducing/画像の縮小
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../registration/index.html" class="md-nav__link">
        Image Registration/ズレ補正
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../automation/index.html" class="md-nav__link">
        Automation/自動処理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        3D Reconstruction, 3D slicer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../icy/index.html" class="md-nav__link">
        3D Reconstruction, Icy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../horos/index.html" class="md-nav__link">
        3D Reconstruction, Horos/OsiriX
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../correlation/index.html" class="md-nav__link">
        Correlation of 2D and 3D images/3D像に切片位置を示す
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../EDF/index.html" class="md-nav__link">
        Extended Depth of Field/深度合成
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ilastik/index.html" class="md-nav__link">
        Segmentation by ilastik/セグメンテーション
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../gallery/gallery/index.html" class="md-nav__link">
        Gallery/作品集
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../publication/publication/index.html" class="md-nav__link">
        Publications/論文
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" data-md-state="indeterminate" type="checkbox" id="__nav_7" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Electronics
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Electronics" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Electronics
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../electronics/ATmega328P/index.html" class="md-nav__link">
        ATmega328P standalone/単体利用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../electronics/terminal/index.html" class="md-nav__link">
        Crimped terminal/圧着端子
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../electronics/vender/index.html" class="md-nav__link">
        Venders/パーツの入手先
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../electronics/mkdocs/index.html" class="md-nav__link">
        Mkdocs-material/HPづくり
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../electronics/camera_terminal/index.html" class="md-nav__link">
        Camera terminal/カメラ端子
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#3d-slicer" class="md-nav__link">
    3D slicerでやること
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1. インストール
  </a>
  
    <nav class="md-nav" aria-label="1. インストール">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#windows" class="md-nav__link">
    Windows
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#macos" class="md-nav__link">
    MacOS
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-dicom" class="md-nav__link">
    2. DICOM編、基本操作に慣れる
  </a>
  
    <nav class="md-nav" aria-label="2. DICOM編、基本操作に慣れる">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    起動、モジュール
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dicom" class="md-nav__link">
    DICOMデータ読込
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#brgy" class="md-nav__link">
    画面表示　B、R、G、Y　青、赤、緑、黄
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    スライス閲覧
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    拡大/縮小
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    移動
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ct" class="md-nav__link">
    CT値の調節
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3d-view3" class="md-nav__link">
    青画面（3D View）、3つの機能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    スクリーンショット
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    閉じ方、2通り
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-combijpeg" class="md-nav__link">
    3. CoMBI、JPEG連続画像編
  </a>
  
    <nav class="md-nav" aria-label="3. CoMBI、JPEG連続画像編">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    単位設定
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jpeg" class="md-nav__link">
    連続JPEG画像の準備
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    ファイル名一括変換、必要に応じて、縮小作業の前に
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#load" class="md-nav__link">
    連続画像の読み込み（Loadとよぶ）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    連続画像の設定
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#volume-rendering" class="md-nav__link">
    Volume Rendering
  </a>
  
    <nav class="md-nav" aria-label="Volume Rendering">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    準備
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    色付け
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    固まったとき
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    なんだか重い
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sceneview" class="md-nav__link">
    表示位置を保存する　モジュールSceneView
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#os" class="md-nav__link">
    動画書き出し（OSの機能、簡易）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3d-slicer2016" class="md-nav__link">
    動画書き出し（3D slicerの機能、2016年より）
  </a>
  
    <nav class="md-nav" aria-label="動画書き出し（3D slicerの機能、2016年より）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ffmpeg" class="md-nav__link">
    事前準備、ffmpegのインストール
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1_1" class="md-nav__link">
    ステップ1　操作を記録
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_1" class="md-nav__link">
    ステップ２　動画を書き出す
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    ヒント
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    保存
  </a>
  
    <nav class="md-nav" aria-label="保存">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    画像データも作業内容もひとつのファイルに保存する（公式サイトでは推奨）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    作業内容を個別に保存する（なにかとメリットはある）
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    セグメンテーション
  </a>
  
    <nav class="md-nav" aria-label="セグメンテーション">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3dslicersegmentation" class="md-nav__link">
    3Dslicerだけで手作業でSegmentationする手順
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    体積の数値を読む
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    工夫やヒント
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3d" class="md-nav__link">
    3Dプリンタ
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="3d-slicer-win-mac-linux">3D slicer （Win, Mac, Linux）</h1>
<p>(This page is still in Japanease only.)</p>
<h2 id="3d-slicer">3D slicerでやること</h2>
<ol>
<li>インストール</li>
<li>DICOM編、基本操作に慣れる<br>
    DICOMデータ読込<br>
    画面表示　B、R、G、Y　青、赤、緑、黄<br>
    スライス閲覧<br>
    拡大縮小<br>
    移動<br>
    CT値の調節<br>
    青画面（3D View）<br>
    スクリーンショット<br></li>
<li>CoMBI, JPEG編、本番です。<br>
    単位設定<br>
    連続JPEG画像の準備<br>
    ファイル名一括変換、必要に応じて<br>
    連続画像の読み込み（Loadとよぶ）<br>
    連続画像の設定<br>
    Volume Rendering<br>
    動画<br>
    保存<br>
    セグメンテーション、体積<br>
    3Dプリンタ<br></li>
</ol>
<p>3D slicerは、無料のオープンソースソフトウェアです。米国ブリガム・アンド・ウィメンズ病院（ハーバード大学関連病院）が 2002年から開発していており、現在もアップデートや機能拡張（Extensions = plug-ins）が続けられています。対応OSは、Windows、Mac、Linuxと幅広いので、多様なCoMBIユーザにおすすめです。<br>
CoMBI開発当初の2014年、JPEG連続画像が扱える3Dビューワを検証し、多機能で動作が軽いOsiriXを選択しました。しかし、OsiriXはのちに有料になり、オープンソース版OsiriXの流れをくむHorosは不安定さが残り、OsiriX/HorosにはMacOSにしか対応しないなど、CoMBI普及の観点からはベストな状況ではありませんでした。かつては、OsiriXと3D slicerとの間に機能的な違いがありましたが、現在はどちらもできることは同じです。（かつては、動画描きだしが簡単にできるOrisiX、できない3D slicerでしたが、2016年の3D slicer v4.6以降は、動画書き出し機能が実装されています。）<br>
3D slicer はノートパソコンでも安定して動作するのを確認しています。大学入学時に購入する典型的なスペック（2018年製,i5-8250U 1.6-1.8GHz, RAM8GB、および、i5-7300U 2.6-2.7GHz, RAM8GB, 共に統合グラフィクス、Windows10）でも動作しました。アプリ本体の容量は、Horos 150MBに対して、3D slicerは1.2GBとなっています。（もし、学生生活が進むに連れ、ディスク残量が少なくなっている場合は、空き容量を確保の上、インストールしましょう。）<br>
本書での3D slicer利用環境は、3D slicer v4.11 (2020.9.30), macOS 10.15.7 iMac 2017 (4.2GHz 4-Core Intel Core i7, ,64GB 2400 MHz DDR4, RadeonPro 580 8GB). MacBookPro15 2018 (2.9GHz 6-Core Intel Core i9, 32GB 2400MHz DDR4, RadeonPro Vega20 4GB), MacBookPro16 (2021, M1 max, 64GB unified) です。3D slicer 公式の推奨環境は、「メモリ最低4GB 推奨8GB〜、単体GPU推奨、データ量より大きいVRAM、CPUマルチスレッド推奨」です。
公式Documentが3D slicerのホームページにあります。また解説動画もネットで多数見つかります。筆者は、3D slicerの練習中で、とくに「動画」「セグメンテーション」はあいまいさ、不完全さがのこります。くわしくはぜひ<a href=https://slicer.readthedocs.io/en/latest/>公式サイト、説明書</a>を参照してください。<br></p>
<hr />
<h2 id="1">1. インストール</h2>
<p>公式サイト　<a href=https://www.slicer.org/>https://www.slicer.org/</a></p>
<p><code>Download Slicer</code>より、OS（Win、Mac、Linux）にあわせてダウンロードする</p>
<h3 id="windows">Windows</h3>
<ol>
<li>インストーラ（.exeファイル）を起動する</li>
<li>インストール先のアドレスは、英語のみで表記されていることが望ましい。</li>
<li>アプリの起動は、Windows Startメニューより</li>
<li>アンインストールは、Windows settingsの、Apps&amp;Featuresを使用する</li>
</ol>
<h3 id="macos">MacOS</h3>
<ol>
<li>インストールパッケージ（.dmgファイル）を起動する。「開発元が確認できません」というメッセージがでる。macOSの<code>System Preferences</code>&gt; <code>Security &amp; Privacy</code>&gt; <code>General</code>&gt; <code>Allow apps downloaded from:</code>で、インストールを許可する</li>
<li>Slicer.appを、Applicationフォルダへ移動（ドラッグ＆ドロップ）</li>
<li>アプリの起動は、Applicationフォルダより</li>
<li>アンインストールは、Slicer.appを削除する</li>
</ol>
<hr />
<h2 id="2-dicom">2. DICOM編、基本操作に慣れる</h2>
<p>サンプルDICOMデータで練習できる。</p>
<h3 id="_1">起動、モジュール</h3>
<ul>
<li>
<p>起動すると、<code>Module</code> <code>Welcome to Slicer</code>が表示される。<strong>モジュール</strong>とは、各種機能のこと。あとにつづく説明で頻繁に出てくる用語</p>
<p><img alt="3D slicer open" src="../img/slicer01.png" title="open" /></p>
<p><em>起動直後、サンプルデータへのボタン</em></p>
</li>
</ul>
<h3 id="dicom">DICOMデータ読込</h3>
<ul>
<li>公式のサンプルDICOMデータを使う場合：とりあえず練習をはじめられる。<code>Download Sample Data</code>ボタンより、まずはひとつ（例えば、CTChest約40MB）ダウンロードする</li>
<li>手持ちのDICOMデータがある場合：Finder（Mac）から、フォルダごと、ドラッグ&amp;ドロップ （ウィンドウ内のどこでもよい）
メッセージ Select a readerでは、パソコン内に患者一覧データベースを作る場合<code>Load directly into DICOM database</code>を選んで<code>OK</code>。とりあえずデータを見たい場合は、<code>Any Data</code>。患者一覧データベースを作った場合：Module<code>DICOM</code>に切り替わって、患者一覧になる。患者名をダブルクリックすると、DICOMデータを表示する画面へすすむ</li>
</ul>
<h3 id="brgy">画面表示　B、R、G、Y　青、赤、緑、黄</h3>
<p>デフォルトでは、4面表示（Four-up）である。赤、緑、黄の画面には、直交面MPR（Multiple Planer Reconstruction）を表示させ、青画面「3D View」には、Volume Rendering などを表示させられる（後述 Volume Rendering）</p>
<ul>
<li>
<p>画面表示を変更するには、上部に並ぶアイコン<code>Layout</code>から選ぶ。または、Menu bar&gt; <code>View</code>&gt;<code>Layout</code>から選ぶ。4画面や1画面など多様なレイアウトから選べる。</p>
<p><img alt="Layout button" src="../img/3dslicer_layout.jpg" title="Layout" /> </p>
</li>
</ul>
<h3 id="_2">スライス閲覧</h3>
<p>連続画像をパラパラとめくって観ることです。CTなどのDICOM画像の場合、一枚の画像をスライスと呼ぶことから、閲覧する行為にも、スライスという用語がでてきます。</p>
<ul>
<li>方法1、マウス：赤、緑、黄、各画面で、<code>scroll wheel of your mouse</code>でめくる</li>
<li>方法2：赤、緑、黄、各画面の上端にある<code>scroll bar</code>でめくる</li>
</ul>
<h3 id="_3">拡大/縮小</h3>
<ul>
<li>方法1、マウス：赤、緑、黄画面の場合、<code>right bottun of your mouse</code>で、上下ドラッグする</li>
<li>方法2、数値入力：押しピン様のマーク<code>Pin-like mark</code>と その下の拡張マーク<code>Extension mark</code>に <code>Field of View</code>があり、数値入力できる。通常は使わないが、動画準備のときに使えそう。</li>
<li>
<p>元に戻すときは、各画面のY、R、Gの横に、中央配置ボタン<code>Centering button</code>というのがある。迷子になったときにこれを押すと便利</p>
<p><img alt="Adjust button" src="../img/3dslicer_scalling.jpg" title="adjust" /></p>
<p><em>Pin-like mark, Extension mark, Centering button, Field of View</em></p>
</li>
</ul>
<h3 id="_4">移動</h3>
<p>赤、緑、黄画面に表示されている画像を上下左右に移動させたいとき</p>
<ul>
<li>Windowsマウスの場合：<code>Pushing center wheel</code>+<code>Drag</code></li>
<li>MacのMagicMouseの場合：<code>Shift</code>+<code>Left button</code>+<code>Drag</code></li>
</ul>
<h3 id="ct">CT値の調節</h3>
<p>明るさとコントラストの調整を行う。CT画像の場合、明るさを明るく/暗くすることを、Window level（L）を上げる/下げると表現する。コントラストを上げる/下げることをWindow width（W）を小さく/大きくすると、表現する。</p>
<ul>
<li>
<p>方法1、マウス：アイコン<code>Adjust</code>で、画像上でドラッグする。上下ドラッグと左右ドラッグで、明るさとコントラストを変える</p>
<p><img alt="Adjust button" src="../img/3dslicer_adjust_button_mark.jpg" title="adjust" /></p>
</li>
<li>
<p>方法2、数値入力： <code>Module</code> <code>Volumes</code>。（上）プリセットボタンが並ぶ、どれかが最適ならラク。（中）プルダウンメニューで、<code>Auto W/L</code>, <code>Manual W/L</code>, <code>Manual Min/Max</code>を選ぶ。<code>Manual W/L</code>では数値を入力できる。（下）<code>Scroll bar</code>でも調節できる</p>
<p><img alt="Module Volume Adjust" src="../img/3dslicer_volume_adjust_mark.jpg" title="adjust" />    </p>
</li>
</ul>
<h3 id="3d-view3">青画面（3D View）、3つの機能</h3>
<ol>
<li>
<p>スライスを青画面に表示（画像一枚を青画面に表示）</p>
<ul>
<li>赤画面の左上、押しピンマーク<code>Pin like mark</code>からでたメニューのうち、眼の印<code>Eye mark</code>で表示のON/OFF。緑、黄でも同様に。   </li>
</ul>
<p><img alt="Show slice" src="../img/3dslicer_show_slice.jpg" title="Show slice" /> </p>
</li>
<li>
<p>Volume Rendringの画像を表示（詳しくは<a href="/image-processing/3dslicer/index.html#volume-rendering">後述「Volume Rendering」</a>）</p>
<ul>
<li>モジュール<code>Volume Rendering</code>を選ぶ</li>
<li>眼の印<code>Eye mark</code>（<code>Volume</code>の左側）のON/OFFで、青画面でのVolume Rendering像を表示/非表示</li>
<li><code>Shift</code>をスライドさせ、明暗を調節する。デフォルトはグレースケール。<code>Preset</code>にカラフルな表示設定がある</li>
</ul>
<p><img alt="Show VR" src="../img/3dslicer_show_VR.jpg" title="Show VR" /> </p>
<ul>
<li>青画面左上のボタン<code>Centering</code>で、中央に表示させる。迷子になったときに便利です</li>
<li>ドラッグして、向きを変えられる。このとき、アイコン矢印のマーク<code>Select tool</code>にしておく</li>
</ul>
<p><img alt="VR basic" src="../img/3dslicer_blue_basic.jpg" title="VR basic" /> </p>
<ul>
<li>マウス<code>Scroll</code>を青画面上で上下させると、拡大縮小</li>
<li>Advanced<code>Volume Properties</code>で、 着色を調節したり、点を下げて透明度を調節したりする</li>
<li>Display<code>Rendering</code> で、dGPUがあるパソコンなら、<code>GPU</code>を選ぶと動作が軽快になる</li>
<li>Display<code>Display ROI</code>で、Volume Renderingする範囲を限定すると、動作が軽快になる。画像中の点<code>Dots in the image</code>を動かす、または、Advanced<code>ROI</code>の<code>Scroll bar</code>を動かす</li>
</ul>
</li>
<li>
<p>セグメンテーションの結果を表示（詳しくは<a href="/image-processing/3dslicer/index.html#_17">後述「Segmentation」</a>）</p>
<ul>
<li>モジュール<code>Segmentation Editor</code>を選ぶ。ボタン<code>Show 3D</code>で表示/非表示を切り替えます。</li>
</ul>
</li>
</ol>
<h3 id="_5">スクリーンショット</h3>
<ol>
<li>
<p>アイコン、カメラマーク<code>Camera mark</code>を押すと、設定ウィンドウがでる。</p>
<p><img alt="Screen shot" src="../img/3dslicer_camera.jpg" title="Screen shot" /> </p>
</li>
<li>
<p>画面を選ぶ</p>
</li>
<li><code>Save as...</code>　ファイル名と場所を指定する。形式はPNGのみ。</li>
<li><code>OK</code></li>
</ol>
<h3 id="2">閉じ方、2通り</h3>
<ol>
<li>アプリを閉じる場合、 <code>Slicer4.11</code>&gt; <code>Quit slicer</code>。またはショートカット、<code>command + Q</code>(Mac)</li>
<li>データだけを閉じる場合、<code>File</code>&gt; <code>Close scene</code></li>
</ol>
<hr />
<h2 id="3-combijpeg">3. CoMBI、JPEG連続画像編</h2>
<h3 id="_6">単位設定</h3>
<p>CoMBIなら、μm表示をえらびたい
1. メニューバー<code>Menu bar</code>より、<code>Edit</code>&gt; <code>Application Settings</code>&gt; <code>Units</code>&gt; <code>Show advanced options</code>にチェックを入れる。
1. ▽<code>Length</code> において、<code>Preset</code>&gt; <code>Select a preset</code>より、<code>Micrometer</code>を選ぶ。<code>OK</code>
1. 3D slicerを再起動させると、変更が反映される。メニューバー<code>Menu bar</code>&gt; <code>Slicer 4.11</code>&gt; <code>Quit Slicer</code>
1. もし、再起動させたらmmにもどってしまう場合は、「アプリを起動 &gt; Unitを選択、OK &gt; 連続画像読み込み &gt; モジュールVolumeで入力 &gt; Save」の順でやってみる。</p>
<p>（2018-2021年メモ：動作が重くなるかもしれないので、µmをmmのままで使うのがよい。単位を真面目に10µmなどにすると、アプリが落ちることがあった。画像は10µm/pixelだったとしても、10mm/pixelと入力する。デフォルトは1mmで、どうやらその付近なら安定していそう。パソコン環境やスペックが影響するかもしれない。XYZの比だけは正しくしておき、計測値が必要な場合は、あとで計算してから利用する。）（2022.3.11 メモ：動作に変化はなかった。mm, µm, 比率をあわせた桁違い、いろいろな入力値を試して、セグメンテーションを実際に行った。MBP16。たんにスペックの問題だったか。かわりに、再起動でµmからmmに戻ってしまう症状をみつけた。）</p>
<h3 id="jpeg">連続JPEG画像の準備</h3>
<p>CoMBIでは、オリジナル画像（RAW形式）をJPEG形式へ変換し、連続JPEG画像として3D解析を行う。3D slicerは、様々な画像形式に対応しており、連続JPEG画像を直接とりこめる。ただし、PNG形式は非対応のようだ。PNGでは、読み込めて（Load）、赤、黄、緑画面での閲覧まではできる。しかし、3D View-青画面（Volume Rendering像など）への表示ができない（一枚だけで不変）。また、透明を設定したPNGでは、透明が反映されず白になる</p>
<h3 id="_7">ファイル名一括変換、必要に応じて、縮小作業の前に</h3>
<p>CoMBIの撮影が通常に成功した場合は、必要ない。撮影中にファイル名が9999から0001に戻ったとか、特別な事情があるときに、ファイル名を一括で変換する</p>
<p>3D slicerの場合、完全な連番が必要です。連番のうしろに残しておいた元ファイル名が飛び飛びの場合、連続画像とは認識されません。完全な連番にしたとき、元データとの照合（実験の再現性確保）ができるように、実験ノートにメモを残す</p>
<p>Horosの場合、頭に連番さえあればよい。</p>
<table>
<thead>
<tr>
<th>変換前</th>
<th>よい例　</th>
<th>3Dslicerではダメな例<br>ただしHorosではよい</th>
</tr>
</thead>
<tbody>
<tr>
<td>DSC_9997.jpg</td>
<td>0001.jpg</td>
<td>0001_DSC_9997.jpg</td>
</tr>
<tr>
<td>DSC_9998.jpg</td>
<td>0002.jpg</td>
<td>0002_DSC_9998.jpg</td>
</tr>
<tr>
<td>DSC_9999.jpg</td>
<td>0003.jpg</td>
<td>0003_DSC_9999.jpg</td>
</tr>
<tr>
<td>DSC_0001.jpg</td>
<td>0004.jpg</td>
<td>0004_DSC_0001.jpg</td>
</tr>
<tr>
<td>DSC_0002.jpg</td>
<td>0005.jpg</td>
<td>0005_DSC_0002.jpg</td>
</tr>
<tr>
<td>DSC_0003.jpg</td>
<td>0006.jpg</td>
<td>0006_DSC_0003.jpg</td>
</tr>
</tbody>
</table>
<ul>
<li>Windows OSで一括変換：<code>Explore</code>で、複数選択<code>Select multiple files</code>、名称変更<code>Rename</code>すると、「入力文字(1).jpg」と、カッコつき連番数字になる。元のファイル名は残らないので注意する</li>
<li>Mac OSで一括変換：<code>Finder</code>で、複数選択<code>Select multiple files</code>、右クリック（副メニュー）<code>Right click, sub-menu</code>より、ファイル名を変更 <code>Rename</code>。完全変更や連番追記など、ある程度カスタマイズできる。プルダウンメニューの<code>Format</code>, 次のプルダウン、<code>Name and Counter</code>を使う</li>
<li>便利に一括変換：Adobe Bridge（有料アプリ）なら細かく設定ができる</li>
</ul>
<h3 id="load">連続画像の読み込み（Loadとよぶ）</h3>
<ul>
<li>連続JPEG画像の読み込みには、フォルダごとドラッグする。または、最初の1枚をドラッグする。新しいウィンドウ<code>Select a reader</code>が出る。プルダウンメニューより、<code>Any data</code>を選び、<code>OK</code></li>
<li>新しいウィンドウ<code>Add data into the scene</code>がでる。自動で連続画像を認識するはずだが、念の為、<code>Show options</code>にチェックをいれてオプション表示させ、<code>Single file</code>に<strong>チェックがないこと</strong>を確認する</li>
<li>連続画像の呼び名を付けられる。ウィンドウ<code>Add data into the scene</code>において、呼び名を入力する。もしくは、のちに<code>Module</code>, <code>Volumes</code>, <code>Active volume</code>のプルダウンメニュー、<code>Rename current volume</code>でも変更できる<blockquote>
<p>3D slicerは、連続画像セットを、複数セット同時に扱える。医療画像における、PET-MRIの重ね合わせ（fusion）のような使い方である。CoMBIであれば、グレースケール連続画像から Volume Renderingを構築し、カラーの断面像 (MPR)を 3面重ねて表示させるといった使い方ができる。3D slicer内での呼び名を決めておき、区別したほうが作業しやすい。デフォルトは、先頭の画像ファイル名になる。私は、Gray for 3Dや Color series などと呼び名を付けて、作業している</p>
</blockquote>
</li>
</ul>
<h3 id="_8">連続画像の設定</h3>
<ul>
<li>ボクセルサイズ、XYZを手入力する。モジュール<code>Volumes</code>, ▽<code>Volume information</code>で、<code>Image Spacing</code>に、入力する。XYは画像のピクセルサイズ、Zは切削厚。</li>
<li>階調数を指定する。モジュール<code>Volumes、Threshold</code>で、JPEGなら、0-255。Autoにすると、0-255になる。デフォルトはCT値っぽい、±1000になってしまう。ここで設定した階調数は、<code>Module</code> <code>Volume Rendering</code>に連動していて、そのときの色付け作業が容易になる。</li>
</ul>
<h3 id="volume-rendering">Volume Rendering</h3>
<h4 id="_9">準備</h4>
<p><img alt="segmetation" src="../img/3dslicer_VR.png" /></p>
<p><em>眼のマークと中央寄せマークです</em></p>
<ul>
<li>モジュール<code>Volume Rendering</code></li>
<li>眼のマーク<code>Eye mark</code>で表示をON/OFFする</li>
<li>青画面左上、中央寄せマーク<code>Centering</code></li>
<li>マウススクロール<code>Scroll your mouse</code>で拡大縮小</li>
<li>マウス左ドラッグ<code>left drag</code>でつかんで回す</li>
<li>複数の連続画像セットを読み込んでいる場合、<code>Volume</code>のプルダウンより、表示させたい連続画像セットを選択する。</li>
<li>▽<code>Display</code>、<code>Rendering</code>プルダウンより、dGPUがあれば、GPUを選んだ方が動作が安定する</li>
</ul>
<h4 id="_10">色付け</h4>
<p><img alt="Volume_Rendering_Coloring" src="../img/3dslicer_color.png" /></p>
<p><em>このようなのをつくっていく手順です</em></p>
<p>▽<code>Advanced...</code>において</p>
<ul>
<li>
<p>色の指定　<code>Scalar Color Mapping</code>。点をダブルクリック、または点をクリックして選択しておいて、<code>Point</code>の隣のボタンで、<code>色</code>を指定する。Point選択や色指定は、右上のプルダウンメニューからもできる。
（今回は3色指定した。血管の明るいシグナルは赤、心筋を黄色、脂肪の暗いシグナルを青に。）</p>
</li>
<li>
<p>次に透明度（各領域）を決める　<code>Scalar Opacity Mapping</code> 点をつかんで移動する。または、点をクリックして、<code>O</code>に数値入力。点は追加できる。ライン上でクリック。点を削除するときは、キーボードのdelete。</p>
</li>
<li>
<p>最後に、全体的な透明度　<code>Gradient Opacity</code>、両端の2点は、クリックして、数値入力。ライン上をクリックすると、点を追加できる。 追加した点は、つかんで調節するか、数値を入力するか、どちらでもよい。</p>
</li>
<li>
<p>面をVolume rendering像にかさねて表示することもできる。各画面の押しピンマーク<code>Pin like mark</code>から眼のマーク<code>Eye mark</code>で表示ON/OFF。</p>
</li>
</ul>
<h4 id="_11">固まったとき</h4>
<p>どきどき青画面3D viewだけ、固まることがある。カーソルでは3Dイメージをぐりぐりできなくなる。ビューワのメニュー（押しピンマーク<code>Pin like mark</code>）から、<code>Auto rotation, 自動回転ボタン</code>を選んで、動かしてみると、カーソルが復帰する場合がある。それでもだめなら、しばらく待つと直っている。</p>
<h4 id="_12">なんだか重い</h4>
<p>表示画質をさげてみます。モジュール<code>Volume Rendering</code>&gt; <code>Advanced</code>&gt; <code>Techniques</code>&gt; <code>Quality:</code>で、描出の質を3種から選べます。もっとも動作が軽快な<code>Normal</code>を選んでみる。デフォルトは<code>Adaptive</code>。<code>Maximum</code>はかなり重いようでほぼ固まります。3種どれでも画質はほとんで変わらず、Normalで十分きれいに描出するようです。</p>
<h3 id="sceneview">表示位置を保存する　モジュール<code>SceneView</code></h3>
<p>3D ビューワや2D ビューワでの表示位置を保存しておくと、いつでも戻ってこられる。ただし、色付けの調整などは保存されていない。Restoreしようとすると、アプリが落ちるときがある（2022.3, v4.11, macOS12.3, iMac2017）</p>
<ol>
<li>モジュール<code>Scene Veiws</code> または、<code>カメラマークの右隣のマーク</code> </li>
<li>新しいウィンドウ<code>3D Slicer SceneView</code>がでる。保存したい画面（R, G, Y, B）を指定できる</li>
<li><code>OK</code></li>
<li>保存したSceneを読み込むときは、モジュール<code>Scene Veiws</code> または、<code>カメラマークのふたつとなり</code>で、Restore</li>
</ol>
<h3 id="os">動画書き出し（OSの機能、簡易）</h3>
<p>macOS付属Screen Shot（Applications&gt; Utilities&gt; ScreenShot.app）で動画と静止画を保存できる。Windows10付属Game Bar（Windows button+G, Setting&gt; Game Bar&gt; ON）で録画、Windows付属Snipping Toolで静止画面を保存できる。メリットは、あらゆる動きが録画できることです。デメリットは、マウスやトラックパッドで3Dイメージを動すので、少々ぎこちなさが残ることです。また、コマ落ちする場合があります。</p>
<p>動画や静止画を様々なパターン（色違いのVolume Rendering、断面表示のON/OFF、SegmentationのON/OFFなど）で作っておき、それらを素材として動画編集アプリ（iMovie, Adobe Premiereなど）で編集します。単純な横回転動画なら、青画面のメニュー（押しピンマーク）内に、回転ボタンがあり、これを利用するとスムースな動きになります。上記のモジュール<code>SceneView</code>をうまく活用すると、素材同士をつなぎ合わせる際に、位置合わせができます。</p>
<h3 id="3d-slicer2016">動画書き出し（3D slicerの機能、2016年より）</h3>
<ul>
<li>動画書き出しを機能させるには、事前にffmpegのインストールが必要</li>
<li>複雑な動きを動画にする場合、作業は二段階あり、ステップ1で操作を記録し（モジュール <code>sequences</code>）、ステップ2で記録したsequenceを呼び出し、動画ファイルに書き出す（モジュール<code>Screen Capture</code>）</li>
<li>単純な回転だけの動画や、単純なパラパラ動画なら、ステップ2（モジュール<code>Screen Capture</code>）だけでできる。ステップ1は不要</li>
<li>この手順書では、「Red 水平面をBlueに表示してめくる、Greenの縦断面をBlueに表示してめくる、VRをBlueに表示し回転」というシナリオで操作を記録し、動画に書き出す。3D slicerでは、操作の記録を<code>Sequence</code>、動画書き出しを<code>Screen Capture</code>と呼び、本手順書ではそれぞれを「ステップ1 操作を記録」、「ステップ2 動画を描き出す」として記す</li>
<li>
<p>動画は、複数のパターンで書き出して、あとで動画編集アプリで編集することが多い。動画のデザインが、より自由になる。</p>
<p><img alt="Movie plan" src="../img/movie_plan.png" /></p>
</li>
</ul>
<h4 id="ffmpeg">事前準備、ffmpegのインストール</h4>
<p>ffmpegは、フレーム画像（連続 PNG）から動画に変換する追加機能。3D slicerアプリは、いったんPNG連続画像を生成してから、動画へと変換する。ffmpegをインストールしないで動画書き出しをやろうとすると、下記の手順ステップ2、▽<code>Advance</code>で赤字エラー<code>Set Valid ffmpeg executable path!</code>が現れる。その横にリンク<code>Help...</code>ができる。かつては、それをクリックすると3D Slicerサイトの解説ページにいけたが、2022.3 v4.11 ではリンクが微妙に切れている。こちらの<a href=https://slicer.readthedocs.io/en/latest/user_guide/modules/screencapture.html#setting-up-ffmpeg>新しい解説ページ</a>に従ってインストールする。ここではMacの手順を転記する。Intel MacとM1 macでは、ffmpegへのパスが異なるので注意。インストールには時間がかかる。Xcodeアップデート30分、homebrew30分、ffmpeg15分、計75分（自宅wifi夜）、大学LANでも合計16分間かかった。</p>
<ol>
<li>アプリ<code>Terminal</code>を起動</li>
<li><code>Homebrew</code>をインストールする。こちらのサイト（<a href=https://brew.sh/>https://brew.sh/</a>）に記載のコマンドを<code>Terminal</code>に打つ。（すでにHomebrewをインストールしていれば不要）</li>
<li>Homebrewをインストールするとき、<code>Xcode</code>インストールまたはアップデートも要求された場合はそれに従う。（既にアップデートしてあれば不要）</li>
<li><code>ffmpeg</code>をインストールする　<code>brew install ffmpeg</code> を<code>Terminal</code>に打つ（6分かかった。2022.5）</li>
<li>Intel macの場合：<ol>
<li>3D slicerのモジュール<code>Screen Capture</code>に戻って、<code>ffmpeg executable</code>の欄に、ffmpegのアドレス <code>/usr/local/bin/ffmpeg</code> を入力する</li>
</ol>
</li>
<li>M1 macの場合（インストール先やバージョンが違うらしい 2022.5.26)<ol>
<li>Terminal.appで、<code>brew info ffmpeg</code>をうって、ffmpegへのパスを探すと、<code>/opt/homebrew/Cellar/ffmpeg/5.0.1</code>と表示される</li>
<li>3D slicer.appで、<code>ffmpeg executable</code>の欄に上記の表示されたアドレスをコピペ</li>
<li><code>...</code>マークを押して別ウィンドウ。実行ファイルを探すと<code>/opt/homebrew/Cellar/ffmpeg/5.0.1/bin/ffmpeg</code>にあった！<code>Open</code>ボタンをおして指定する</li>
<li>これで動画書き出しができるようになります。</li>
</ol>
</li>
</ol>
<h4 id="1_1">ステップ1　操作を記録</h4>
<p>操作している様子を記録できる。画面（Red, green, yellow, blue）を指定できる。ここでは「Red 水平面をBlueに表示してめくる、Greenの縦断面をBlueに表示してめくる、VRをBlueに表示し回転」というシナリオ（<code>Sequence browser</code>）を例として、操作を記録する</p>
<ol>
<li>
<p>表示スタイルを選ぶ</p>
<ul>
<li>本例では、赤画面、緑画面、青画面を使いたいので、4画面表示（Conventional, Conventional widescreen, Four Upなど）を選ぶ。ここで選ぶのは操作記録用の表示スタイルで、目的の操作がしやすければ何でも良い</li>
<li>のちのステップ2、動画を書き出す際は、動画書き出しに適した表示スタイルに変更する（3D onlyなど）。</li>
</ul>
<p><img alt="Window styles" src="../img/window_style.png" /></p>
</li>
<li>
<p>モジュール<code>Sequences</code></p>
</li>
<li>タブ<code>Browse</code>, プルダウン<code>Sequence browser</code>より、<code>Create new sequence browser as...</code>, 新しいウィンドウ<code>Rename sequence</code>で、名前を決めて入力する（本例では、「2-planes-rotate」と名付けた）</li>
<li>▽ <code>Synchronized nodes</code> （本例では、3種類のウィンドウ「赤画面で画像をめくる」「緑画面で画像をめくる」「青画面3D viewでVolume Rendering像を回転」を記録する）</li>
<li>ボタン<code>Green PLUS</code>で <code>sequence</code>をつくる。（こんかいは、3回押して、上記3種のウィンドウを指定する）</li>
<li><code>Proxy node</code>を設定、各<code>sequence</code>に、赤画面<code>Red</code>, 黄画面<code>Yellow</code>, 青画面<code>Camera</code>を設定。（プルダウンには Camera が複数あって、記録されるCameraと記録されないCameraがある、らしい。いちどやってみて、ダメなら順に選んで試す）</li>
<li>▽ <code>Browsing</code>, ボタン<code>Red CIRCLE</code>で記録開始する。停止も<code>Red CIRCLE</code>。動かしている時間だけ記録される。静止している時間は記録されない、らしい。（「1. 赤で画像をめくる、2.黄で画像をめくる、3.3D viewでVolume Rendering像を動かす」）</li>
<li>
<p>▽ <code>Browsing</code>, ボタン<code>Green TRIANGLE</code>で再生し、記録した操作を確認する。停止もボタン<code>Green TRIANGLE</code></p>
<p><img alt="Brows and Sybchronized nodes" src="../img/sequences.png" /></p>
</li>
</ol>
<h4 id="2_1">ステップ２　動画を書き出す</h4>
<p>記録した操作（ステップ1で作った<code>Sequence browser</code>）から、動画ファイル（mpeg4）を書き出す。ひとつの操作記録から、多様な動画を描き出せる。例えば、表示VRを切り替えたり、表示断面像の切り替えたり、それらの表示／非表示を選んだりできる。生成される動画の大きさと形は、表示させているウィンドウの大きさと形を反映したものになる。</p>
<ol>
<li>モジュール<code>Utilities</code> &gt; <code>Screen Capture</code></li>
<li>
<p>▽ Inputの設定</p>
<ul>
<li><code>Master View:</code> 本例では、青画面3D viewを記録したいので<code>View 1</code>を選ぶ。もし複数の青画面を表示させているなら、View1, 2, 3...から適切な青画面を選ぶ</li>
<li><code>Animation mode:</code> ステップ1で記録した <code>sequence</code>を呼び出して動画にする場合は、<code>sequence</code>を選ぶ（本例ではこちら）。<code>3D rotation</code>の場合、単純な回転動画が生成され、記録した<code>sequence</code>を必要としない。</li>
<li><code>Sequence:</code> ステップ1で記録した <code>sequence</code> を指定する。本例では「2-planes-rotate」を指定した。</li>
<li><code>Start index:</code>, <code>Stop index:</code> 記録したsequenceのどこを利用するか指定できる。本例では最初の19フレームを不採用にして、Startは20からとした。Stopは変更せず、1170のまま、最後まで採用した。 </li>
</ul>
</li>
<li>
<p>▽ Outputの設定</p>
<ul>
<li><code>Output type:</code>　動画書き出しの場合<code>Video</code>を選択する。PNG連続画像を生成した後、動画mpeg4に変換してくれる。<code>Image series</code>の場合、PNG連続画像を生成する</li>
<li><code>Number of images</code>, <code>Video length</code>, <code>Video frame rate</code>を設定する。本例では300flames, 10sec, 30flames/secとした。（設定に関するヒントは下記参照）</li>
<li><code>Output directory :</code>, <code>Output file name :</code> 保存場所とファイル名を設定する</li>
<li>ボタン<code>Capture</code>で、書き出しを開始する。下の小窓にステータスが表示され、完了すると<code>Done</code>と表示される。時間がかかる</li>
<li>（ボタン<code>ARROW</code>（Capture隣）は、書き出した動画ファイルへのショートカット）</li>
</ul>
<p><img alt="Screen Capture" src="../img/screen_capture.png" /></p>
</li>
<li>
<p>表示スタイルを選ぶ</p>
<ul>
<li>書き出される動画の大きさと形状は、表示されている状態を反映する。本例では青画面だけを書き出したいので、表示スタイルは、「3D only」にして、大きさと縦横比を好みに合わせる。このときの表示状態をScene Viewに保存しておくと便利だが、Restore時にアプリが落ちることがある</li>
</ul>
</li>
<li>
<p>表示させたいものを選ぶ</p>
<ul>
<li>赤画面、緑画面などで表示させる連続画像（カラー、グレーなど）を選べる。2021: 各画面の<code>押しピンマーク</code>、<code>眼マークの隣のプルダウン</code>、<code>眼マーク</code>で設定する（これは効かない!）。2022.8: ステップ1の、モジュール<code>Sequence</code>、<code>Proxy node</code>でRedやYellowを設定したところ、右側の再生チェックを外す。</li>
<li>Volume Renderingを選んだり、表示／非表示を選べる。モジュール<code>Volume Rendering</code>にて、<code>Volume:</code>, <code>眼マーク</code>で設定する。選び終えたら、モジュール<code>Screen Capture</code>に戻る</li>
<li>セグメンテーションがあれば、モジュール<code>Segmentations</code>にて、各セグメントの表示／非表示を選べる。選び終えたら、モジュール<code>Screen Capture</code>に戻る</li>
</ul>
</li>
<li>
<p>書き出し</p>
<ul>
<li>（モジュール<code>Screen Capture</code>に戻って）</li>
<li>▽ Outputの、ボタン<code>Capture</code>で、書き出しを開始する。下の小窓にステータスが表示され、完了すると<code>Done</code>と表示される。時間がかかる</li>
<li>（ボタン<code>ARROW</code>（Capture隣）は、書き出した動画ファイルへのショートカット）</li>
</ul>
</li>
</ol>
<h4 id="_13">ヒント</h4>
<ul>
<li>一般のビデオは、30 frame/secondである。5秒動画ならPNG150枚や、10秒動画ならPNG300枚が生成され、動画に変換される。300枚ともなると、だいぶ時間がかかる。PNG生成ではGPUとシングルコアが働き、連続PNGからの動画変換でマルチコアが働く。かかる時間は、パソコンのスペックによるし、待てる時間はひとそれぞれ。まずは100枚以下で様子を見てから、設定を調整し、何度かためしてみる</li>
<li>キャプチャしたい（動画にしたい）ウィンドウを大きく表示していると、時間がかかる</li>
<li>Volume Renderingも、Segmentsも両方表示していると、時間が掛かる</li>
<li>動画開始位置をSceenViewを記録・登録しておくと安心。いろんな表示条件（VRのON/OFF, SegmentのON/OFFなど）で多様な動画を書き出したいとき、万が一、スタート位置をずらしてしまっても、戻って来られる</li>
</ul>
<h3 id="_14">保存</h3>
<p>2通りある。画像データや作業内容を、まとめてひとつのファイルとして保存する方法と、個別にする方法がある</p>
<h4 id="_15">画像データも作業内容もひとつのファイルに保存する（公式サイトでは推奨）</h4>
<p>拡張子はmdb。画像、着色、シーンなどの設定を一括して保存できる</p>
<ol>
<li>アイコン<code>SAVE</code> ウィンドウの左上。新しいウィンドウ<code>Save Scene and Unsaved Data</code>がでてくる。</li>
<li>プレゼント箱みたいなアイコン<code>Present box-like</code>をONにして、mrbを指定</li>
<li>保存先を指定する。外付けディスクを指定する場合だけ注意：ファイル右横のマーク<code>...</code>から指定すること。下のボタン<code>Change directory for selected files</code>では指定できない。</li>
<li>開くときは、mrbファイルを3D slicer のウィンドウへ、ドラッグ&amp;ドロップする。保存したときの作業状態が再現される。</li>
</ol>
<h4 id="_16">作業内容を個別に保存する（なにかとメリットはある）</h4>
<p>生成されるファイルのうち、.mrml（シーン設定）、.png（シーン、アイコンの代わり）、.nrrd（連続画像）は、必須のファイル。もし、作業していれば、.seg.nrrd（セグメントをまとめたファイル）や、.h5（Transformのファイル）など追加で生成される。シーンとは、作業していたウィンドウの状況.mrmlと、見た目.pngのことである。見た目のpngのおかげで、次に開くときに作業内容を思い出しやすい。個別ファイルが使いやすい場面として、複数サンプルに同一処理、たとえば、Volume Renderingで、複数サンプルに同じ着色をしたいときや、セグメンテーションは軽い連続画像でやっておいて、できあがったらセグメンテーションだけを重い連続画像と合わせたいときが考えられる。また、上書き保存が速いというメリットもある。</p>
<ol>
<li>アイコン<code>SAVE</code> ウィンドウの左上。新しいウィンドウ<code>Save Scene and Unsaved Data</code>がでてくる。</li>
<li>mrbをOFF。<code>プレゼント箱ボタン</code></li>
<li>保存先はデフォルトなら、.mrml, .png, /Data。連続画像と作業ファイルは「Data」フォルダに保存される。変更してもよいが、階層構造をのちのち保つこと。変更する場合は、マーク<code>...</code>で個別に、下のボタン<code>Change directory for selected files</code>で一括して行う</li>
<li>開くときは、.mrmlファイルのみを3D slicerのウィンドウにドラッグドロップする。ほかはリンクされていて、自動で一括して開かれる。ただし、保存時の階層構造を保っておく必要がある。</li>
<li>上書き保存では、ボタン<code>SAVE</code>をおすと、別ウィンドウがでて、左のボタン<code>Select Scene &amp; Modidied Data Only</code>にチェックが入っている。これで、.mrml（シーン設定）、.png（シーン、アイコンの代わり）と、更新したファイルのみが保存される。となりの<code>Modidied Data Only</code>にすると、シーンが更新されない。</li>
<li>ヒント：Segmentのファイル名は、[Active segmentation].seg.nrrdになっている。モジュールSegmentationsでCreate New Segmentationsでつくった名称＝複数のセグメントをまとめているところの名称。</li>
</ol>
<h3 id="_17">セグメンテーション</h3>
<ul>
<li>3Dslicerだけで手作業でSegmentationする手順を下に示します。使用するツールは、<code>Paint</code>と<code>Fill between slices</code>と<code>Smooth</code>だけにしてシンプルです。他に領域限局やシグナル強度の範囲指定など、さまざまなツールが備わっていますが、CoMBIのフルカラー画像なら、基本の<code>Paint</code>と<code>Draw</code>が役立つでしょう</li>
<li>抽出したい対象物によっては、3D slicerだけでは不便な場合もあるでしょう。iLastikは、機械学習でSegmentationして、二値化やグレースケール連続画像をつくってくれます。こちらのページ<a href="../ilastik/index.html">「Segmentation by iLastik」</a>に記しました。また、Photoshopは、「色域指定」で二値化連続画像をつくれます。こちら<a href="../horos/index.html#3">Horosのページの中の「色域指定」</a>に記しました。iLastikやPhotoshopでつくった二値化やグレースケール連続画像は、3D slicerで<code>Volume Rendering</code>したり、<code>Segmentation</code>, <code>Threshold</code>を施したりします。</li>
<li>推奨の作業環境は、タッチペンです。私はMacBookPro15 2018またはMacBookPro16 2021にiPad Pro 2018 A12X（SideCar）をつなげ、Apple Penで描いています。SideCarでの接続は、無線より有線のほうが安定します。Windowsノートなら元々タッチパネルになっている商品があって便利そうです。WindowsマシンにiPadをつなげるアプリもいくつかあるようですが、私は試していません</li>
<li>Segmentaionのデータは、mrbファイルなら一括して保存されます。Segmentaionデータだけの独立ファイルとして保存することも選べます。その場合、別のmrbに移入させられます。Segmentation作業は必要最低限のデータセットで軽快に行い、本番用の重いデータセット（RGB, grayscale, ilastik, WT-Hetero-Knockoutなど）に移入させるといった使い方ができます</li>
<li>
<p>本手順書は、はじめトリハツをつかった例で執筆しました。のちに<code>Fill between slices</code>と<code>Smooth</code>のところを追記し、マウスE12中腸が登場します。ややこしいですが基本的に下図のトリハツ大血管をセグメンテーションする手順です</p>
<p><img alt="segmetation" src="../img/3dslicer_seg.png" /></p>
<p><em>このようなのをつくっていく手順です。これはトリハツ。手順書の途中にマウスE12中腸も登場します</em></p>
</li>
</ul>
<h4 id="3dslicersegmentation">3Dslicerだけで手作業でSegmentationする手順</h4>
<ol>
<li>モジュール<code>Segmentation</code>の場合、Active segmentation: より、Create new segmentation。モジュール<code>Segment editor</code>の場合、Segmentation: より、Create new segmentation。ここで作るSegmentationは、フォルダのようなもの。フォルダの中に複数のSegment（例、動脈と静脈）が収まる。二つのモジュール<code>Segmentation</code>と<code>Segment editor</code>はほぼ一体のモジュールで、それらの間を行き来するには、ボタン<code>Segmentation...</code>やボタン<code>Edit selected</code>である。迷子にならないように</li>
<li>ボタン<code>Add segment</code>で、新規セグメント<code>Segment_1</code>をつくる。名前は自由に変えられる。このときは大動脈を塗ることにしたので、名称を「Artery」とした。表示色を変えるには、四角い色表示をクリックする</li>
<li><code>Paint</code>で、大動脈を塗りつぶした<ul>
<li>全画像で塗る必要はなく、5枚に1枚とか、10枚に1枚の画像で塗る。等間隔がおすすめ、修正しやすいため。とびとびでよいし、がたついても良く、のちに補完（Fill between slices)と平滑化（Smooth）で仕上げる</li>
<li><code>Show 3D</code>ボタンを押しておくと、青画面（3D view）にリアルタイムで表示されていく。さらに、モジュール<code>Volume Rendering</code>で、VR像も表示させると、セグメントと同時に確認できる。しかしながら、動作がかなり鈍くなるので、塗りつぶし作業中はShow 3D OFF、Volume renderingもOFFとしておき、ときどき確認するときだけ表示ONにしている</li>
<li>今回の例題である大血管は輪状だったので、<code>Draw</code>ではなく、<code>Paint</code>を使った。<code>Draw</code>は、描いた線の内側をすべて塗りつぶすモード。使い方は、<code>Draw</code>+ <code>Return, Enter</code>。Drawで線を描いたあとにリターンキーをおすと、その内部が塗りつぶされる。描くのは、円形でも、弧でもよい（PowerPointやIllustratorの、線と塗りつぶしの関係と同様）。</li>
</ul>
</li>
<li><code>Erase</code>で塗りすぎたところを削除して、修正する</li>
<li>
<p><code>Fill between slices</code>で補完（モジュール<code>Segment Editor</code>）</p>
<p><img alt="Fill between slices" src="../img/fillbetweenslice1.png" /></p>
<p><em>Process of <code>Fill between slices</code>. Reference serial images are 5x5x10 µm/voxel, 1220x875 pixels, 820 images of mouse mid gut on E12 (Not chick heart). <code>Draw</code> in the RED plane for whole mid gut every 5 images, and in the YELLOW plane for in a loop every 10 images.</em></p>
<ol>
<li><code>Initialize</code> すこし待つ</li>
<li><code>Show 3D</code> ONで青画面に表示させる。スライドバーで描いたセグメントと補完したセグメントの透明度を調整し見やすくする</li>
<li>がたつきがひどければ、<code>Paint</code>と<code>Erase</code>で修正する。<code>Auto update</code>にチェックをいれて おくと、修正中に、<code>Fill between slices</code>の像に反映されていく</li>
<li><code>Apply</code>で完了。ボタン<code>Undo</code>で元に戻せる。全体を塗れたと思ってから行う。多少の修正は、<code>Erase</code>を使ったりして、あとでもできる。多少のガタツキは次の<code>Smooth</code>で直せる</li>
<li>Apply後に修正が必要なら、<code>Erase</code>などで修正する。変な突起ができたり、近接構造が融合したりして、修正したことがある</li>
</ol>
</li>
<li>
<p>ボタン<code>Add segment</code>で、<code>Segment_2</code>もつくる。「Vein」と名称をつけて、<code>Paint</code>で肺動脈を塗った。同様にFill between slicesも行った</p>
</li>
<li>
<p><code>Smooth</code>で滑らかにする（モジュール<code>Segment Editor</code>）</p>
<p><img alt="Smooth comparison" src="../img/smooth.png" /></p>
<p><em>Comparison of smoothing methods and settings. Note that voxel size were set as 5x5x10 mm/voxel at volume module, instead of original 5x5x10 µm/voxel (millimeter instead of micrometer), for stabilize PC performance. Processing were done using MacBookPro16 M1 max. Time in yellow indicate duration of prosseccing after clicking <code>Apply</code>.</em></p>
<ol>
<li>Smoothing Method: <code>Joint smoothing</code>を好んで使用している。（Joint smoothingは、表示中の複数のSegmentを処理し、処理時間が短い。MedianやGaussianは、選択中のセグメントだけを処理し、処理時間が長い。MedianやGaussianの設定では、長さを入力する。Medianでは、pixelsが表示される。1x1x1だと変化なし、3x3x1だとトゲくらいならなくなる。7x7x7, 11x11x7などでようやくJoint smoothing_0.5相当になるが、処理時間が非常に長くなる）</li>
<li><code>Joint smoothing</code>の設定では、数値を入力する。まずはデフォルトの0.5を試す</li>
<li><code>Apply</code>で完了</li>
<li>満足できなければ、ボタン<code>Undo</code>と、設定値の変更（0.3-1.0）、<code>Apply</code>を繰り返す</li>
<li>細かい修正が必要なら、<code>Erase</code>などを使用する。近接構造が融合してしまい、Eraseで修正した例を下に示す</li>
</ol>
<p><img alt="Erase" src="../img/erase.png" /></p>
<p><em>Unwanted connection was erased in the RED plane using <code>Erase</code> tool, and visualized in 3D View. 赤画面において、不必要につながった場所をEraseで消した</em></p>
</li>
<li>
<p>Volume Renderingとセグメントを重ねて表示し確認できる。モジュール<code>Volume rendering</code>、マーク<code>Eye</code>で、青画面への表示をON。動作が鈍くなるのでOFFにして作業に戻る</p>
</li>
<li>アイコン<code>Camera</code>（Capture Screenshot）で、静止画に描き出せる</li>
<li>Saveのとき、一括ファイルか、Segmentationのみの個別ファイルかを選べる。別のプロジェクトへ移入させたいときは個別ファイルにする</li>
</ol>
<h4 id="_18">体積の数値を読む</h4>
<ul>
<li>モジュール<code>segmentation</code>&gt;<code>Quantification</code>&gt;<code>Segment statistics</code>（このモジュールをクリックすると、ウィンドウデザインが変わって、数値一覧がでる。CSVにでも書き出せば、Excelなどで使える。練習中）</li>
</ul>
<h4 id="_19">工夫やヒント</h4>
<ul>
<li>
<p>最初はうまく行かないもの</p>
<p>まず一度、セグメンテーションをおおざっぱにやってみて、使うツール、塗る間隔、完成形の見通しをたてます。2回目以降を本番としています。</p>
</li>
<li>
<p>ツールを選ぶ</p>
<p>色と形がはっきりしていれば、<code>Level tracing</code>が使えます。マウスポインターがある色と類似の色を島状に選択してくれます。<code>mouse over</code>+<code>Left click</code>。CT画像にはいいかもしれませんが、CoMBIの画像ではあまり出番はないかもしれません。もっとも、対象物によります。色が淡く、境界がぼんやりしている場合は、<code>Paint</code>, <code>Draw</code>, <code>Erase</code>を使います。</p>
</li>
<li>
<p>塗る画像は等間隔</p>
<p>画像めくりはキーボードの矢印キー。等間隔のほうが、のちの修正がラク。例えば、2, 5, 10枚ごとにしています。</p>
</li>
<li>
<p>MPR（多平面再構築）で角度をつけると、Segmentationできない</p>
<p>多平面（赤画面、黄画面、緑画面）において、角度をつけてからSegmentationしたら、とびとびになって、まともなSegment, Fill between, Smoothになりません。「サンプルちょっと斜めで包埋されていたから、角度を調節して、きっちりと横断面、矢状断面にしたい」ということがあるかもしれませんが、Segmentation作業を先にして、角度調整はあとまわしにしてください。</p>
</li>
<li>
<p>複雑な形状</p>
<p>中腸は、グニャグニャと曲がって、複数のループがある。案1：個々のループで別のセグメントにして後で融合する。案2：はじめから単一セグメントでやりたい場合、同じ画像上で、複数ループを塗ること。ダメなのは「こっちのループはこの画像で塗って、あっちのループはあっちの画像で塗る」ことで、その場合、補完が破綻する（下図）</p>
<p><img alt="Fill between slices" src="../img/fillbetweenslice2.png" /></p>
<p><em>Four parts of mid gut are shown. [Upper panel] <code>Draw</code> every 5 images for all 4 gut and preview <code>Fill between slices</code>.  [Lower panel] When <code>Draw</code> additional region only in the left-most gut (stars), <code>Fill between slices</code> was broken.</em></p>
</li>
<li>
<p>セグメントの中にセグメントを作りたい</p>
<p>「モジュール<code>Segmentaion</code>と、モジュール<code>Edit segmentaion</code>」は、「フォルダとファイル（パソコンの基本操作）」、「グループとオブジェクト（illustrator）」と捉えることができます。例えば、心臓全体のセグメント１つと、各心室のセグメントを４つ作りたいときがあるとします。心臓全体のセグメントは、モジュール<code>Segmentation</code>で、Active segmentation: <code>Create new...</code> をつくって、その中に心臓全体セグメントを<code>Add</code>して、<code>Edit selected</code>(モジュール<code>Edit segment</code>)します。各心室用には、モジュール<code>Segmentation</code>で、Active segmentation: <code>Create new...</code>で、また別のSegmentationをつくり、その中に、４つ心室用Segmentを<code>Add</code>し、編集します。</p>
</li>
<li>
<p>作業の所要時間とセグメントの綺麗さのバランス</p>
<p>「1面（赤画面）目では、対象物全体を等間隔できっちりDrawし、2面目は補助的にDrawする」<br>
1面（赤画面）だけよりは、2面（緑か、黄）で塗った場合のほうが、セグメントの仕上がりが良い。しかし、多くの面で塗ると、時間がかかる。境界があいまいでも、別の面でははっきり見える場合が多いので、多面塗りには価値がある。境界があいまいで自信がないとき、1面目では、控えめ・小さめに塗り、別の面で自信を持って塗るとよい</p>
</li>
<li>
<p>作業が重い</p>
<p>参照する連続画像（モジュール<code>Segmentation</code>では<code>Master Volume</code>と表記）の大きさと枚数が、動作に影響します。カラーJPEGで500x500x500枚程度が限度のようでした（Table.1）。もっとも、パソコンのスペックにもよるとは思います。Segmentation作業用の3D slicerファイルは、縮小/減数シリーズ（500 x 500 x 500）をつかって、もし高画質シリーズ（1000 x 1000 x 1000）に重ねる必要があれば、あとでセグメンテーションファイルだけを移入するのがいいと思います。<br></p>
<p>連続画像の枚数を減らすと軽くなりますが、セグメントは荒くなります。Fill between sliceの結果が悪くなるためです。XY:Z＝1:1, 1:2, 1:4くらいが限度でしょう。1:10 (例、5µm x 5µm x 50µm, 1000 x 1000 x 200枚)ではくっきりとした階段ができてしまい、さっぱりダメでした（Table.2）。そうかといって、高画質の1:2 (5µm x 5µm x 10µm, 1000 x 1000 x 1000枚)にすると重くなるし、もどかしいところです。<br></p>
<p>Segmentationの数が10個〜20個と多くなると、パソコンの動作が鈍くなっていきます。<br></p>
<p>Segmentationの大きさが大きくなると、動作が鈍くなります。例えば、マウス胚で眼球一つのセグメントと、胚子全体のセグメントを比較すると、眼球は余裕なのに、胚全体はフリーズしそうになりました（Table.2,3）。<br></p>
<p>2018-2021年は、MacBookPro15（2018, i9, 4GB-HBM2, 32GB）、2022年からは、MacBookPro16（2021, M1 max, 64GB unified memory）を使っています。マシンが良くなっても、Segmentが大きくなったり、Segmentの個数が増えれば、動作が重くなります。500 x 500 x 1000枚（0.8 GB）なら、安定して作業できました。M1 maxは、1000 x 1000 x 1000枚（3.3 GB）でも扱えそうでしたが、順調なのは最初だけで、大きなSegmentになっていくと、かなり鈍くなり実用的ではありませんでした（Table.3）。<br></p>
<p>Table 1: Datasets for testing segmentation performance. Specimen: whole embryo of mouse on E12, computer: MacBookPro16 M1 max. </p>
<table>
<thead>
<tr>
<th>Datasets&nbsp;</th>
<th>1220 x 875 pixels,<br>820 images</th>
<th>610 x 438 pixels,<br>820 images</th>
<th>1220 x 875 pixels,<br>164 images</th>
<th>610 x 438 pixels,<br>164 images</th>
</tr>
</thead>
<tbody>
<tr>
<td>Type</td>
<td>RGB, 8bit</td>
<td>RGB, 8bit</td>
<td>RGB, 8bit</td>
<td>RGB, 8bit</td>
</tr>
<tr>
<td>Folder<br>original JPEG images</td>
<td>64 MB</td>
<td>43 MB</td>
<td>14 MB</td>
<td>9 MB</td>
</tr>
<tr>
<td>3D slicer format<br>.mrb</td>
<td>685 MB</td>
<td>303 MB</td>
<td>137 MB</td>
<td>43 MB</td>
</tr>
<tr>
<td>Size<br>as TIFF</td>
<td>3.3 GB</td>
<td>0.84 GB</td>
<td>0.66 GB</td>
<td>0.165 GB</td>
</tr>
<tr>
<td>XYZ size (voxel)</td>
<td>5 x 5 x 10 µm</td>
<td>10 x 10 x 10 µm</td>
<td>5 x 5 x 50 µm</td>
<td>10 x 10 x 50 µm</td>
</tr>
</tbody>
</table>
<p>Table 2: Segmentation of small object; an eye ball.</p>
<table>
<thead>
<tr>
<th>Process&nbsp;</th>
<th>1220 x 875 pixels,<br>820 images</th>
<th>610 x 438 pixels,<br>820 images</th>
<th>1220 x 875 pixels,<br>164 images</th>
<th>610 x 438 pixels,<br>164 images</th>
</tr>
</thead>
<tbody>
<tr>
<td>Draw<br>Show 3D ON</td>
<td>A slight delay <br>after <code>Enter</code></td>
<td>No delay</td>
<td>No delay</td>
<td>No delay</td>
</tr>
<tr>
<td>Fill between slices<br>initialize</td>
<td>No delay</td>
<td>No delay</td>
<td>No delay</td>
<td>No delay</td>
</tr>
<tr>
<td>Fill between slices<br>quality</td>
<td>Good, <br>filled smoothly</td>
<td>Good, <br>filled smoothly</td>
<td>Bad, <br>filled like steps.</td>
<td>Bad, <br>filled like steps.</td>
</tr>
</tbody>
</table>
<p>Table 3: Segmentation of large object; whole body of mouse E12.</p>
<table>
<thead>
<tr>
<th>Process&nbsp;</th>
<th>1220 x 875 pixels,<br>820 images</th>
<th>610 x 438 pixels,<br>820 images</th>
<th>1220 x 875 pixels,<br>164 images</th>
<th>610 x 438 pixels,<br>164 images</th>
</tr>
</thead>
<tbody>
<tr>
<td>Draw<br>Show 3D ON</td>
<td>(not tested)</td>
<td>(not tested)</td>
<td>10 to 20 sec delay<br>after <code>Enter</code></td>
<td>5 to 10 sec delay<br>after <code>Enter</code></td>
</tr>
<tr>
<td>Fill between slices<br>Initialize</td>
<td>(not tested)</td>
<td>(not tested)</td>
<td>1 min 25 sec delay, <br>after <code>Enter</code></td>
<td>18 sec delay, <br>after <code>Enter</code></td>
</tr>
<tr>
<td>Fill between slices<br>Show 3D</td>
<td>(not tested)</td>
<td>(not tested)</td>
<td>immediately</td>
<td>immediately</td>
</tr>
<tr>
<td>Fill between slices<br>Apply</td>
<td>(not tested)</td>
<td>(not tested)</td>
<td>10 sec delay<br>after <code>Enter</code></td>
<td>2 sec delay<br>after <code>Enter</code></td>
</tr>
<tr>
<td>Smooth<br>Joint smoothing</td>
<td>(not tested)</td>
<td>(not tested)</td>
<td>55 sec delay<br>after <code>Enter</code></td>
<td>16 sec delay<br>after <code>Enter</code></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Segmentationの結果が粗い</p>
<ol>
<li>最初は、とびとびに塗っていき、</li>
<li>まずは<code>Fill between slices</code> &gt; <code>Initalize</code>の結果を見ます。軽微な不連続がみつかったら、すでに塗った場所を丁寧に修正します（<code>Paint</code>, <code>Draw</code>, <code>Erase</code>など）。塗りの修正でも治らない場合は、塗る枚数を増やします。連続性的にFillされたら、<code>Fill between slices</code> &gt; <code>Apply</code>します。</li>
<li>次に、<code>Smoothing</code>をつかってみます。<code>Joint Smoothing</code>, <code>0.5</code>を試します。修正したい窪みや突起があれば、丁寧に修正します（<code>Paint</code>, <code>Draw</code>, <code>Erase</code>など）。</li>
<li>繰り返し、<code>Smoothing</code>と修正をします。満足できるまで</li>
</ol>
</li>
<li>
<p>キーボードの矢印キーが効かない</p>
<p>いちどズームイン・ズームアウトすると、効くようになることがあります。そのうちに効くようになることもあります</p>
</li>
<li>
<p>DrawやPaintが効かない</p>
<p><code>Draw</code>で描いたあと<code>Retrun</code>を押しても反応しないときや、Paintが無反応になるときがあります。いちどズームイン・ズームアウトする。もしくは、ツールを矢印<code>None</code>に一旦切り替えてから、改めて<code>Draw</code>を選ぶと、効くようになることがあります。どうしても効かないときは、アプリを再起動します</p>
</li>
<li>
<p>iPad, Side car, Apple penで表示位置が飛ぶ</p>
<p>ズームイン・ズームアウト（ピンチイン・ピンチアウト）して、元の見たい位置に戻します。入力デバイスが多く（Apple Pen、マウス、トラックパッド、キーボード）どこかに触れてしまうとずれる時がありました。また、スライスめくりのバーをApplePenで操作すると位置飛びが起こりますが、マウスで操作すると飛ばないようです。</p>
</li>
<li>
<p>青画面に断面像を表示できない</p>
<p>眼のマーク<code>Eye mark</code>でON,OFFしてもなにも起こらなかったり、真っ黒な画像が表示されたりすることがありました。いったん、モジュール<code>Data</code>で、連続画像を捨てて、改めて連続画像を読み込みます。<code>Data Load</code>または、<code>Drag &amp; Drop</code>。この症状が見られたのは、Volume renderingとSegmentationと断面を同時に表示をさせようとしたときでした。かなり重い作業です</p>
</li>
<li>
<p>単位設定を忘れてた！　</p>
<p>単位をµmに変えるのを忘れ、mmのままでSegmentation作業を進めてから気づいたことがありました。そんなとき、あとでモジュール<code>Transform</code>で修正できます。例として、60x60x80mmではなく、60x60x40µmにしたいとき、行列表示に、0.06, 0.06, 0.08と斜めに入力します。</p>
</li>
</ul>
<h3 id="3d">3Dプリンタ</h3>
<p>モジュール<code>Segmentations</code>から、3Dプリンタ用なら、STLなど外部へのExportを行う。モジュール<code>Segmentations</code>には、別のExportもあって、3D slicer内のモジュール<code>Model</code>へのExportである。ややこしい。</p>
<ul>
<li>
<p>3Dプリンタ用のデータを出力する。<code>Export to files</code> ファイルとして、外部にExportされる。きっと3Dプリンタ用。</p>
<ol>
<li>Destination folderをきめる。保存先。</li>
<li>Visble segments only; このみでチェック。</li>
<li>Reference vol: わからないがデフォルト、連続画像セットの名称が記されている。</li>
<li>File format: STL</li>
<li>Scale size: （CoMBIのデータなら、µmが多いけど...まだ試していない）</li>
<li>ボタン<code>Export</code></li>
</ol>
</li>
<li>
<p>3D slicer内のモジュール<code>Model</code>へ出力する。<code>Export/Import models and labelmaps</code></p>
<ol>
<li>Operation: <code>Export</code>, </li>
<li>Output type: Models, Output node: </li>
<li>Export models to new folder (デフォルト、赤い矢印ボタンでデフォルトに戻る)</li>
<li>Advancedはいじらないで。</li>
<li>ボタン<code>Export</code></li>
<li>モジュール<code>Model</code>にSegmentがうつった。モジュール<code>Data</code>にデータが増えたことを確認できる。3D slicer内でのExport。きっと、いろんないろつけ。Segmentの表面をレインボーカラーなどカラフルにしたり、各スライスでの色を違えたりできる。</li>
</ol>
</li>
</ul>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      © 2021 Tajika Y, CC BY-NC
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.expand"], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.6e54b5cd.min.js"></script>
      
    
  </body>
</html>