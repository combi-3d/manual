
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Manual of CoMBI">
      
      
      
        <meta name="author" content="Tajika Y.">
      
      
      <link rel="shortcut icon" href="../../img/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.4">
    
    
      
        <title>Horos/OsiriX (Mac) - Manual of CoMBI</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.15aa0b43.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.75751829.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7C&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#horososirix-mac" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="Manual of CoMBI" class="md-header-nav__button md-logo" aria-label="Manual of CoMBI">
      
  <img src="../../img/logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            Manual of CoMBI
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Horos/OsiriX (Mac)
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Manual of CoMBI" class="md-nav__button md-logo" aria-label="Manual of CoMBI">
      
  <img src="../../img/logo.png" alt="logo">

    </a>
    Manual of CoMBI
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      



  <li class="md-nav__item">
    <a href="../../index.html" class="md-nav__link">
      Top page
    </a>
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" data-md-state="indeterminate" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Installation/導入
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Installation/導入" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        Installation/導入
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../../devices/system/index.html" class="md-nav__link">
      System Overview/概要
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../devices/camera/index.html" class="md-nav__link">
      Imaging devices/カメラなど
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../devices/selfmade/index.html" class="md-nav__link">
      Self-made devices/自作装置
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../devices/computer/index.html" class="md-nav__link">
      Computer and storage/コンピュータとストレージ
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../devices/application/index.html" class="md-nav__link">
      Applications/アプリケーション
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" data-md-state="indeterminate" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Instruction/操作
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Instruction/操作" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Instruction/操作
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../../operation/combi-c/index.html" class="md-nav__link">
      CoMBI-C (Cryostat)
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../operation/combi-s/index.html" class="md-nav__link">
      CoMBI-S (Sliding, motorized)
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../operation/combi-s-m/index.html" class="md-nav__link">
      CoMBI-S (Sliding, manual)
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../operation/combi-r/index.html" class="md-nav__link">
      CoMBI-R (Rotary, manual)
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" data-md-state="indeterminate" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Image Processing
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Image Processing" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        Image Processing
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../introduction/index.html" class="md-nav__link">
      Overview/画像処理の概要
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../rawjpeg/index.html" class="md-nav__link">
      RAW to JPEG conversion/RAW現像
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../scale/index.html" class="md-nav__link">
      Resize/画像の縮小
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../registration/index.html" class="md-nav__link">
      Image Registration/ズレ補正
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../3dslicer/index.html" class="md-nav__link">
      3D Reconstruction, 3D slicer
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../icy/index.html" class="md-nav__link">
      3D Reconstruction, Icy
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="index.html" class="md-nav__link">
      3D Reconstruction, Horos/OsiriX
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../correlation/index.html" class="md-nav__link">
      Correlation of 2D and 3D images/3D像に切片位置を示す
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../EDF/index.html" class="md-nav__link">
      Extended Depth of Field/深度合成
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../ilastik/index.html" class="md-nav__link">
      Segmentation by ilastik/セグメンテーション
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../../gallery/gallery/index.html" class="md-nav__link">
      Gallery/作品集
    </a>
  </li>

    
      
      
      



  <li class="md-nav__item">
    <a href="../../publication/publication/index.html" class="md-nav__link">
      Publications/論文
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#things-to-do-in-horososirix" class="md-nav__link">
    Things to do in Horos/OsiriX /やることリスト
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bugs-in-horos" class="md-nav__link">
    Bugs in Horos/バグ
  </a>
  
    <nav class="md-nav" aria-label="Bugs in Horos/バグ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#202103-20216" class="md-nav__link">
    プラグインをインストールできない 2021.03 （2021.6 できるようになった）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mprvr-202012" class="md-nav__link">
    MPR/VRからの動画描きだし 2020.12
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2020" class="md-nav__link">
    セグメンテーション後 2020
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#horos-2020" class="md-nav__link">
    新しいHorosが起動しない 2020
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    インストール、プラグイン追加（初回だけ）
  </a>
  
    <nav class="md-nav" aria-label="インストール、プラグイン追加（初回だけ）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    インストール
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    プラグイン
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#horos" class="md-nav__link">
    Horosの基礎、ウィンドウについて
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jpegdicom" class="md-nav__link">
    JPEG連続画像を取り込む（DICOMに変換して取り込む）
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    データベース（患者名）を整理する
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    グレースケール連続画像の利用
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    カラー連続画像の利用
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    基本操作
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2d-orthogonal-mpr" class="md-nav__link">
    2D orthogonal MPR
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3d-mpr" class="md-nav__link">
    3D MPR
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3d-volume-rendering" class="md-nav__link">
    3D Volume Rendering
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#segmentation" class="md-nav__link">
    セグメンテーション　Segmentation
  </a>
  
    <nav class="md-nav" aria-label="セグメンテーション　Segmentation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1roi" class="md-nav__link">
    1.明暗でROI指定
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2roi" class="md-nav__link">
    2.手作業でROI指定
  </a>
  
    <nav class="md-nav" aria-label="2.手作業でROI指定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    準備
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#roiroi" class="md-nav__link">
    ROI指定、ROIファイル保存
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#roi3d" class="md-nav__link">
    ROIを3D再構築像に重ね合わせる
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    体積の数値
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3.色域指定
  </a>
  
    <nav class="md-nav" aria-label="3.色域指定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#photoshop" class="md-nav__link">
    Photoshop
  </a>
  
    <nav class="md-nav" aria-label="Photoshop">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    ヒント
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#horososirix" class="md-nav__link">
    Horos/OsiriX
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#imagejfijihorosroi" class="md-nav__link">
    ImageJ/FIJIで二値化したのちHorosでROI
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="horososirix-mac">Horos/OsiriX (Mac)</h1>
<p>(This page is still in Japanease only.)</p>
<h2 id="things-to-do-in-horososirix">Things to do in Horos/OsiriX /やることリスト</h2>
<ol>
<li>インストール、プラグイン追加（初回だけ）</li>
<li>Horosの基礎、ウィンドウについて。</li>
<li>連続JPEG画像をとりこむ。DICOM変換</li>
<li>データベース（患者名）を整理する</li>
<li>グレースケール連続画像は、３D再構築Multiple planer reconstruction (MPR)とVolume Rendering（VR）に利用する</li>
<li>カラー画像は、３D再構築Multiple planer reconstruction (MPR)に利用する</li>
<li>動画を書き出す</li>
<li>関心領域　Region of Interest（ROI）<ol>
<li>明暗でROI指定（Horosだけでやる方法）</li>
<li>手作業でROI指定（Horosだけでやる方法）</li>
<li>色域指定（Photoshopで処理してからHorosでやる方法）</li>
</ol>
</li>
</ol>
<hr />
<h2 id="bugs-in-horos">Bugs in Horos/バグ</h2>
<h3 id="202103-20216">プラグインをインストールできない 2021.03 （2021.6 できるようになった）</h3>
<p>v3.3.6をインストール後、プラグイン（JPEG-DICOM）を追加しようと思ったら、一覧が出てきません。「No Horos plug-in server available.」となります。以前にインストールされたHorosとJPEG-DICOMはそのまま使えますが、やはり一覧がでません。アプリからサーバにアクセスできないようです。ただし、コンテンツ（下記）は存在しているようです。下記のサイトから、JPEGtoDICOMへ移動し、その中のJPEGtoDICOM.horosplugin.zipをダウンロードします。Horosを起動した状態で、ダウンロードしたファイルをダブルクリックするとインストールができるようです。</p>
<p>https://horosproject.org/horos-content/plugins/horos/</p>
<h3 id="mprvr-202012">MPR/VRからの動画描きだし 2020.12</h3>
<p>Horos 3.3.6やそれ以前のバージョンで、MPR(多平面再構築)から動画を描き出したいとき、Movie Exportを行います。しかし、書き出される動画が小さく(たてよこのピクセル数が少なく)なってしまうというバグがあります。v4.0.0 Release Candidate4では、やや大きくなるので実用的ですが、こんどはVolume Renderingでバグがります。いまのところ、新旧を使い分けるくらいしか、対応策がありません。新旧のバージョン両方をインストールして、区別するために名称変更して使っています。データベースフォルダは共通で使えるので、データベースが倍増することはありません。OsiriXでは問題ありません。</p>
<ul>
<li>Horos 3.3.6:MPR動画は小さくて使いにくい(一辺約500 pixel)。VR動画は正常。</li>
<li>Horos 4.0.0RC4:MPR動画はやや大きくなってなんとか使える(一辺約700 pixel)。VR動画はFly Thruの座標がずれるので使えない。</li>
<li>OsiriX MD v11(有料版):MPR動画は大きくて実用的。VR動画は正常。</li>
</ul>
<h3 id="2020">セグメンテーション後 2020</h3>
<p>Segmentationした領域の体積数値をみようとしたら、落ちました。いちおう回避策はありますが、この件でも、セグメンテーションは、3D slicerにしようと思いました。</p>
<h3 id="horos-2020">新しいHorosが起動しない 2020</h3>
<p>Horos 4.0.0 RC5（2020.12）は、2Dビューワが起動しません。MBP13（2105）、OS11.1 Big Sur。</p>
<hr />
<h2 id="_1">インストール、プラグイン追加（初回だけ）</h2>
<h3 id="_2">インストール</h3>
<p>https://horosproject.org ここからダウンロード、インストールする。日本語環境が用意されているが、フリーズするので、英語のまま使用すること。開くと、いろいろメッセージが出てくるけれど、とりあえず使ってみる。<code>Continue</code>ボタン。</p>
<h3 id="_3">プラグイン</h3>
<p>プラグイン「JPEG to DICOM」をインストール、<code>Plug-ins</code> <code>Plug-in Manager</code>で、新しいウィンドウが開く。上部の<code>Horos Plugins</code>をクリックし、プルダウンで<code>JPEG to DICOM</code>を選ぶ。下部の<code>Download &amp; Install</code>をクリック。この作業は、インストール後の使い始めに一度行うだけです。</p>
<h2 id="horos">Horosの基礎、ウィンドウについて</h2>
<p>ウィンドウは、大きく分けて3種類あり、さらに派生したウィンドウもある。よく使うウィンドウを下記に5種類挙げた。データベースウィンドウで、見たいデータをダブルクリックして、2Dビューワを出す。2Dビューワで、メニューやボタンを使って、3Dビューワを出す。</p>
<ol>
<li>データベース（起動時のウィンドウ）</li>
<li>2Dビューワ<ol>
<li>連続画像の閲覧</li>
<li>Orthogonal Planer Reconstruction 直行面再構築</li>
</ol>
</li>
<li>3Dビューワ<ol>
<li>Multiple Planer Reconstruction 多平面再構築</li>
<li>Volume Rendering ボリュームレンダリング、など</li>
</ol>
</li>
</ol>
<h2 id="jpegdicom">JPEG連続画像を取り込む（DICOMに変換して取り込む）</h2>
<ol>
<li><code>Plug-ins</code>&gt;<code>Database</code>&gt;<code>JPEG to DICOM</code></li>
<li>連続画像を含むフォルダに行って、すべての画像を選択する。最初の画像を<code>Click</code>、最後の画像を<code>Shift+Click</code>。または<code>Cntrl+A</code>。画像が多いと、選択されるのに、数秒かかる。</li>
<li>試料名(患者名)や、実験日(検査日)などを入力する。私は、実験日、試料名、画像のピクセルサイズを入力している。</li>
<li>開く、<code>Open</code>（多少、時間がかかる）</li>
<li>ほかにも連続画像があれば、作業を繰り返す</li>
</ol>
<p><strong>ヒント</strong></p>
<ul>
<li>
<p>過去のHorosバージョンでは、フォルダを選択するだけで、取り込めました。しかし、新しいバージョンでフォルダ選択で取り込んだ場合、画像の順がバラバラになります。きっとバグです。上記のようにすべての画像を選択する操作を入れると、正常に取り込めます。有料OsiriXでは、2021年1月のJPEG to DICOMプラグインのアップデートがあり、フォルダ選択が可能に戻りました。</p>
</li>
<li>
<p>ファイル名を連番にする。一括変換、必要に応じて、縮小作業の前に</p>
<p>CoMBIの撮影が通常に成功した場合は、必要ありません。ファイル名が9999から0001に戻ったとか、特別な事情があるときに、ファイル名を一括で変換します。</p>
<p>3D slicerの場合、完全な連番が必要です。連番のうしろに残しておいた元ファイル名が飛び飛びの場合、連続画像とは認識されません。完全な連番にしたとき、元データとの照合（実験の再現性）ができるように、メモを残してください。</p>
<p>Horosの場合、頭に連番さえあればよい。</p>
<table>
<thead>
<tr>
<th>変換前</th>
<th>よい例　</th>
<th>3Dslicerではダメな例<br>ただしHorosではよい</th>
</tr>
</thead>
<tbody>
<tr>
<td>DSC_9997.jpg</td>
<td>0001.jpg</td>
<td>0001_DSC_9997.jpg</td>
</tr>
<tr>
<td>DSC_9998.jpg</td>
<td>0002.jpg</td>
<td>0002_DSC_9998.jpg</td>
</tr>
<tr>
<td>DSC_9999.jpg</td>
<td>0003.jpg</td>
<td>0003_DSC_9999.jpg</td>
</tr>
<tr>
<td>DSC_0001.jpg</td>
<td>0004.jpg</td>
<td>0004_DSC_0001.jpg</td>
</tr>
<tr>
<td>DSC_0002.jpg</td>
<td>0005.jpg</td>
<td>0005_DSC_0002.jpg</td>
</tr>
<tr>
<td>DSC_0003.jpg</td>
<td>0006.jpg</td>
<td>0006_DSC_0003.jpg</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Windows OSで一括変換：<code>Explore</code>で<code>複数選択</code>、<code>名称変更</code>すると、「入力文字(1).jpg」と、カッコつき連番数字になる。元のファイル名は残らないので注意。</p>
</li>
<li>Mac OSで一括変換：<code>Finder</code>で<code>複数選択</code>、<code>右クリック（副メニュー）</code>より、ファイル名を変更。完全変更や連番追記など、ある程度カスタマイズできる。</li>
<li>便利に一括変換：Adobe Bridge（有料アプリ）なら細かく設定ができる。</li>
</ul>
<h2 id="_4">データベース（患者名）を整理する</h2>
<p>同一標本から、複数の連続画像シリーズ（カラーシリーズとグレースケールシリーズ、サイズ違い）ができる。それぞれで取り込むと、リストには 2行、3行と、複数患者として表示されてしまう。これを、同一標本なら1行（1患者名）にして、派生したシリーズ（複数の検査項目）をまとめて表示させられます。</p>
<ol>
<li>まとめたい行(患者名)を複数選択する。<code>Shift + click</code></li>
<li>選択した行の上で、<code>Right click</code>し、<code>Merge Selected Studies</code>を選ぶ。 </li>
<li>チェック項目では、上2つの項目にチェックが入っていることを確認する。<code>Use same Patient ID</code>, <code>Merge as a single study</code></li>
<li><code>OK</code></li>
</ol>
<h2 id="_5">グレースケール連続画像の利用</h2>
<p>すべての3D再構築法に利用できる。2D orthogonal MPR, 3D MPR, 3D curved MPR, 3D MIP, 3D volume rendering, 3D surface rendering, 3D endoscopy。</p>
<ol>
<li><code>3D viewer</code>または<code>歯車マーク</code>より、</li>
<li><code>3D MPR</code>, <code>3D volume rendering</code>などを選ぶと、別のウィンドウがでる。</li>
<li>再構築する前に、ボクセルサイズを入力する。XYはピクセルサイズ、Zは切削厚。ヒトCT用アプリなので、単位がmmしかない。µｍだとおもって入力する。</li>
</ol>
<p><strong>ヒント</strong></p>
<ul>
<li>
<p><code>Shift</code>を押しながら、MPRやVRを選択すると、毎回、ボクセルサイズを入力する画面をだせる。</p>
</li>
<li>
<p>Volume RenderingでもMPRでも、初期表示では、暗いかもしれないが、明るさやコントラスト(Window level、Window Width)をいじって、見やすくする。</p>
</li>
<li>
<p>まれに、<code>歯車マーク</code>（2D/3D再構築)が消えてしまうことがあります。こうなると「Volume dataではありません」というたぐいのメッセージがでて、先に進めません。原因不明です。解決することはしますが、いいかげんです。次の３つのうちどれかです。</p>
<ol>
<li>
<p>そのまま数秒待つと出てきた。</p>
</li>
<li>
<p>次の日にはできた。</p>
</li>
<li>
<p>ほかのパソコンではできた。いずれも同一のデータセットです。</p>
</li>
</ol>
</li>
</ul>
<h2 id="_6">カラー連続画像の利用</h2>
<p>面の再構築にだけ利用できる。2D orthogonal MPR, 3D MPR</p>
<ol>
<li><code>3D viewer</code>または<code>歯車マーク</code>より、</li>
<li><code>2D orthogonal MPR</code>または<code>3D MPR</code>を選ぶと、別のウィンドウがでる。</li>
<li>再構築する前に、数値を入力する。XYはピクセルサイズ、Zは切削厚。ヒトCT用アプリなので、単位がmmしかない。µｍだとおもって入力する。</li>
</ol>
<p><strong>ヒント</strong></p>
<ul>
<li><code>Shift</code>を押しながら、MPRなりVRを選択すると、毎回数値入力画面をだせる。3Dウィンドウでは、最初は、暗いかもしれないが、明るさやコントラスト(Window level、Window Width)をいじって、見やすくする。</li>
<li>まれに、<code>歯車マーク</code>（2D/3D再構築)が消えてしまうことがあります。こうなると「Volume dataではありません」というたぐいのメッセージがでて、先に進めません。原因不明です。解決することはしますが、いいかげんです。次の３つのうちどれかです。1)そのまま数秒待つと出てきた。2)次の日にはできた。3)ほかのパソコンではできた。いずれも同一のデータセットです。</li>
</ul>
<hr />
<h2 id="_7">基本操作</h2>
<p>下図、左から、明るさとコントラストの調整、移動、拡大縮小、回転、3D回転（Volume Rendering用）。画面を上下左右にドラッグする。ツール選択は、それぞれのボタンを押すか、ショーロカットキーを押すか。ショートカットキーのほうが断然便利です。連続画像をめくるのは、マウススクロールなど。</p>
<p><img alt="horos" src="../img/horos01.png" title="basic tools" /></p>
<p><em>いつもつかう、基本のツール</em></p>
<p>パソコンモニタが小さい場合、ツールボタンが隠れるときがあります。隠れていれば、右端のマーク<code>&gt;&gt;</code>を押すとでてきます。もしくは、よく使うボタンやメニューを左へ寄せることもできます。ツールボタンがあるグレーの領域で、右クリックすると、ツールボタンの表示位置や有無をカスタマイズできます。</p>
<h2 id="2d-orthogonal-mpr">2D orthogonal MPR</h2>
<p>直行面だけで、3面を再構築できる。次の3D MPRより軽い作業。グレースケール連続画像、カラースケール連続画像の両方でできる。静止画、動画、距離の計測ができる。下記の3D MPRとほぼ同じなので、説明は省きます。</p>
<h2 id="3d-mpr">3D MPR</h2>
<p>任意の面を再構築する。グレースケール連続画像、カラースケール連続画像の両方でできる。</p>
<ul>
<li>初期表示は、まっくらな場合がある。<code>Thick Slab</code>をいじると画像がでてくる。左横の数字を大きくする。たぶん初期値1。2,3,4...10...と大きくしてみる。</li>
<li><code>色つき軸</code>を握って、回転させる。<code>軸の交点</code>を握って、中心を移動させる。</li>
<li><code>明るさコントラスト調整</code>はぎこちない。初期の表示がいいことが多いが、いろいろいじってみるのも価値あります。下記の３つを変えながら、明るさコントラスト（WL, WW）を変えて、よさそうなところがみつかるか、どうか。<ol>
<li><code>Opacity</code>のプルダウンを変えてみる。</li>
<li><code>Thick Slab</code>で重ね合わせる量を変えてみる。</li>
<li><code>Mode</code>で重ね合わせの種類を変えてみる。</li>
</ol>
</li>
<li>画面に表示される文字たちを消したいとき、キーボード<code>Tab</code>を何度か押して表示モードを選択します。</li>
<li>色つき軸の表示をON/OFFできます。ツールバーに<code>十字マークのボタン</code>があります。</li>
<li>静止画の書き出し、クリックしてアクティブになっているウィンドウを書き出せる。<code>File</code>, <code>Export</code>, <code>JPEG</code>や<code>TIFF</code>など。</li>
<li>動画の書き出し、<code>File</code>, <code>Export</code>, <code>Movie</code>。Horosの場合、不安定。小さな画面で書き出されてしまう。小さくてもよければ使えます。もしくは、直交面MPRでよければ、そちらのほうは安定しています。OsiriX（有料）は、問題ない。
<code>From</code>, <code>To</code>で範囲を決める。Intervalでは、<code>Same as thicknessにチェック</code>すると高精細。重ければ、スライドバーで調整する。</li>
<li>メニューバーのボタン、計測ツール、<code>Length</code>で距離をはかれます。</li>
</ul>
<hr />
<h2 id="3d-volume-rendering">3D Volume Rendering</h2>
<p>いかにも3D画像を再構築する。美しい画像は魅力的である。画像を見せるだけで実験データとして済むなら、このVolume Renderingだけでよい。しかし、Volume Renderingだけでは数値化には向かない。長さは3D MPR、体積はSegmentationで行うのがよい。Volume renderingと、Segmentationした領域を組み合わせて表示させることもできる。</p>
<ul>
<li>最初の設定：もしGPUが別についているマシンなら、ツールバー内にあるGPUにチェックをいれます。もしくは、<code>Horos</code>&gt;<code>Reference</code>,<code>GPU</code>,<code>Renderer</code>,<code>GPUにチェック</code>します。そのほうが快適に動作するでしょう。</li>
<li>動作が重いとき、<code>Level of Detail</code>のスライダーを、<code>Fine</code>から<code>Coarse</code>に寄せます。粗い表示にすると軽くなる。作業は粗い表示で、いざ静止画や動画に描き出すときは、細かい表示を使います。</li>
<li>画面に表示される文字たちを消したいとき、キーボード<code>Tab</code>を何度か押して表示モードを選択します。</li>
<li>画面のさいころ様のマークは、<code>Orientation</code>です。ツールバーのボタンで表示をON/OFFします。</li>
<li>明るさとコントラスト window level and window width
基本ツールで、上下左右ドラッグします</li>
<li>
<p>色つけ CLUT 8 bit、まずはプリセット、CLUTのプルダウンから選べます。カスタマイズして、プリセットを作って保存することもできます。</p>
</li>
<li>
<p>色つけ CLUT 16 bit、豊かな階調で色付けできます。カスタマイズしてプリセットとして保存できます。</p>
</li>
<li>
<p>静止画の書き出し <code>File</code>, <code>Export</code>, <code>JPEG</code>や<code>TIFF</code>など。</p>
</li>
<li>動画の書き出し Fly Thru<ol>
<li>ツールバーの<code>ボタンFly Thru</code>を選びます。または、メニューバーの<code>3D viewer</code>, <code>Add Fly Thru Point</code>を選びます。</li>
<li>Stepを記録　ちょっと動かしては、<code>+</code>ボタンをおして、繰り返します。動かしたい奇跡をまずは点で記録しています。あとで点を結んで動画にします。</li>
<li>オプション　記録した点を、ファイル保存できます。下のボタン<code>Export</code></li>
<li>動画　タブ<code>Movie</code>に移ります</li>
<li>Number of Frames, 作りたい動画の長さを、秒数×30で入力。一般に、30 frame/secです。10秒動画にしたいなら、300です。</li>
<li><code>Compute</code>を一度押します。</li>
<li>形式<code>QuickTime</code>、Quality:<code>Best Rendering</code>、Size <code>Current</code>。次のステップで重すぎれば、サイズを調整してください。</li>
<li><code>Save</code>,ファイル名を決めたりして、書き出しは時間がかかる。 
ヒント、クロップ操作も記録できます。明るさコントラスト調整は、記録できない、ことが多い。たぶんバグ。</li>
</ol>
</li>
</ul>
<hr />
<h2 id="segmentation">セグメンテーション　Segmentation</h2>
<p>セグメンテーションは、特定の領域（関心領域、Region of Interest、ROI）だけを選択すること、描出することです。選択したROIからは、体積の数値が得られます。実験では、セグメンテーションが目標になる場合があるでしょう。
ROIを指定する方法として、一般的な画像（グレースケールのDICOM画像）では、明暗で選択する方法(Horos/ROI&gt;Grow Region)と、形状を手作業で選択する方法(Horos/ボタンClosed Polygon)があります。CoMBIの場合、カラー画像なので、色域指定も利用できます(Photoshop/選択範囲/色域指定 + Horos/Grow Region)。</p>
<ol>
<li><strong>明暗でROI指定</strong>: 明暗のコントラストがハッキリし、かつ、輪郭がハッキリした形状であればうまくいくでしょう。例えば、ヒトCTデータなら、骨や肺です。しかしながら、研究試料のCoMBI連続画像では、この方法ではうまくいかないことが多いでしょう。この方法だけでは思い通りに指定できず、結局手描きがいいとなるでしょう。</li>
<li><strong>手作業でROI指定</strong>: 見手作業は確実です。ROI指定で参照する画像は、グレースケールでもカラーでも使えます。CoMBIの場合、カラー画像は参照しやすく価値があります。ROI情報はテキストデータに保存され、あとでVolume Renderingによる3D再構築像に重ねて表示できます。ただし、自動ではない分、時間がかかります。例えば、頚リンパ節 19個を選択するのに半日かかりました。</li>
<li><strong>色域指定</strong>: Photoshopなどで、カラー連続画像を参照し、色域指定を自動で行えます。指定領域を二値化した連続画像をあらたに生成し、ROI(Grow Region)を自動で行います。二段階になりますが、いずれも自動です。色域指定にはPhotoshopやImageJがつかえます。Photoshopの場合、指定条件は見た目で、スポイトで選択します。さらに、複数の色を追加したり、削除したりできるのは便利です。しかし、数値入力では指定できません。ImageJの場合、RGB、彩度、明暗の各情報を数値入力で指定します。しかし、複数色の追加や削除が容易ではありません。</li>
</ol>
<hr />
<h3 id="1roi">1.明暗でROI指定</h3>
<p>グレースケール画像で、明るさだけで選択する。あんまりうまくいかないと思うのであっさりと記載します。</p>
<ol>
<li>直行面MPRのウィンドウで行います（3D MPRでもできます）。</li>
<li>グレーでもカラー画像でも使えます。</li>
<li>ROI/Grow Region</li>
</ol>
<h3 id="2roi">2.手作業でROI指定</h3>
<h4 id="_8">準備</h4>
<ol>
<li>直行面MPRのウィンドウで行います（3D MPRでもできます）</li>
<li>グレーでもカラー画像でも使えます。</li>
</ol>
<h4 id="roiroi">ROI指定、ROIファイル保存</h4>
<ol>
<li><code>ボタンClosed Polygon</code>で複雑な形状でもROIにする。</li>
<li>数枚ごとにROIを囲む。</li>
<li>描いたROIとROIの間を自動で埋める。 <code>ROI</code> &gt; <code>ROI Volume</code> &gt; <code>Generate missing ROIs</code>
このとき、描いたROIがあるスライスを表示しておく。ROIがないスライスだと、メニューが非アクティブで押せない。</li>
<li>
<p>ROI の名前をきめる
<code>ROI</code> &gt; <code>ROI rename</code> &gt; <code>All ROIs in this series</code>
(<code>ROI</code> &gt; <code>ROI manager</code> を開いておくと、名前が決まったのが見える)</p>
</li>
<li>
<p>ROIを保存する。
<code>ROI</code> &gt; <code>Save All ROIs in this series</code>
(拡張子、rois_series)</p>
</li>
<li>複数のROIを指定したいとき、いったん最初のROIを削除する
<code>ROI</code> &gt; <code>Delete all ROIs in this series</code></li>
<li>複数のROIを指定するには、上記を繰り返す。
（注意）ROIファイルが複数できることになります。どれがどれか分かるように、ファイル名を決めます。</li>
</ol>
<h4 id="roi3d">ROIを3D再構築像に重ね合わせる</h4>
<ol>
<li>3D再構築につかうグレースケール連続画像を2D Viewerに表示させる。（データベースウィンドウで、データをダブルクリックすると、表示されるのが2D Viewer）
)</li>
<li>roi_seriesファイルを読み込む<code>ROI</code> &gt; <code>Import ROIs</code>
複数あれば複数回読み込む。 </li>
<li>3D 再構築
<code>3D</code> &gt; <code>Volume Rendering</code> XYZのスケールを入力し、3D Viewer モードになる</li>
<li>ROI ファイルのリストを表示 <code>ROI</code> &gt; <code>ROI manager</code>
「3D ROI manager」というウィンドウが開く。読み込んだROIのリストが表示される (メニュー表記は同じだが、上記の 2DViewer モードのときは異なるウィンドウ)</li>
<li>ROI表示のオンオフと着色　左端のチェック欄に、チェックを入れると、VRに重ねて表示される。 表示色を変更できる。透明度も調整できる。</li>
</ol>
<h4 id="_9">体積の数値</h4>
<p>3通りあるがHorosで安定しているのは１だけ。</p>
<ol>
<li><code>2D viewerのROI manager</code>、<code>Volume</code>が表示される。
下記のComputeVolumeよりやや大きめに出るが、比較データのときは、数値をよむ方法を統一すればよい。Horosは、これだけが安定している。</li>
<li>3D Viewerで、<code>ROI</code> &gt; <code>ROI Volume</code> &gt; <code>Compute Volume</code>
注意:Horosはよく落ちるのでおすすめしない。OsiriXは安定している。</li>
<li><code>3D ViewerのROI manager</code> でも、<code>Volume</code> が表示されるが、小さいモノはゼロとなったり、数値が変になる。おすすめしない。</li>
</ol>
<h3 id="3">3.色域指定</h3>
<p>Photoshopで二値化したのちHorosでROI指定する。2段階だが全自動。</p>
<h4 id="photoshop">Photoshop</h4>
<ol>
<li>準備 カラー連続画像は、Photoshop色域指定用、 グレースケール連続画像は、Horos, VR用。フォルダを新規にひとつつくる（二値化白黒連続画像用）</li>
<li>カラー画像のうち、色域指定に使えそうな一枚だけ開く</li>
<li>アクションで記録開始<ol>
<li>Photoshopで、特定の色を選ぶ。<code>選択範囲 Select</code>&gt;<code>色域指定 Color Range...</code>　許容量を少なめ（5とか）にして、スポイトで指定する。追加 (+)や削減(ー)を使って調節する。</li>
<li>二値化白黒画像とする<ol>
<li>OKボタンをおすと、選択領域が表示される。</li>
<li>キーボード<code>Delete</code>で選択範囲を削除する。削除後の色は<code>White</code>を指定する</li>
<li>（必要なら、境界線をなめらかにする。<code>選択範囲 Select</code>&gt; <code>選択範囲の変更 Modify</code>&gt; <code>滑らかに Smooth...</code>）</li>
<li>選択範囲を反転させる。<code>選択範囲 Select</code>&gt; <code>反転 Inverse</code></li>
<li>キーボード<code>Delete</code>で選択範囲を削除する。削除後の色は<code>Black</code>を指定する</li>
<li><code>イメージ Image</code>&gt; <code>モード Mode</code>&gt; <code>グレースケール grayscale</code> </li>
</ol>
</li>
<li>別名で保存　<code>Save as</code>新しく作っておいたフォルダを指定して保存する</li>
<li>画像を閉じる <code>Close</code></li>
</ol>
</li>
<li>アクションの記録停止</li>
<li>連続画像に、記録したアクションを一括処理する　<code>ファイル File</code>&gt; <code>自動処理 Automate</code>&gt; <code>バッチ Batch...</code></li>
</ol>
<h5 id="_10">ヒント</h5>
<p>アクションが途中で止まる：選択領域が全くない場合、選択範囲の反転で、止まっていました。対策として、すべての画像の端っこに、指定したい色で極小の四角を描きました。これで、すべての連続画像にわずかでも選択範囲が存在することになり、アクションが正常に行われました。</p>
<p>忘れた：二値化画像をRGBのまま保存すると、以降のHorosでうまくROIが選べない。グレースケールにするのを忘れずに。</p>
<p>アクションをDropletファイルとして保存しておけば、別の実験での同一処理につかえます。</p>
<h4 id="horososirix">Horos/OsiriX</h4>
<ol>
<li>二値化白黒連続画像をHorosに読み込む　<code>plug-in</code>, <code>JPEG to DICOM</code> 
連続画像を全選択して（一番最初の画像をクリック、shiftを押しながら一番最後の画像をクリック）、読み込む</li>
<li>読み込んだ二値化データをダブルクリックし、2D viewerをひらく</li>
<li>ROI を指定する
 <code>ROI</code>, <code>Grow Region</code> 閾値は適当に100とする（どうせ二値化なのでハズレなし）</li>
<li>ROI ファイルに保存。<code>ROI</code>, <code>Save all ROIs in this series</code></li>
<li>データベースウィンドウに戻り、グレースケール連続画像（VR用）をダブルクリック。2D viewerを開く。</li>
<li>保存したROI ファイルを読み込む　<code>ROI</code>, <code>Import ROI</code></li>
<li>3D 再構築する。 <code>Volume Rendering</code>で3D Viewerがひらく</li>
<li>ROI の表示設定 <code>ROI</code>, <code>ROI manager</code></li>
<li>静止画も動画も書き出せる</li>
</ol>
<h4 id="imagejfijihorosroi">ImageJ/FIJIで二値化したのちHorosでROI</h4>
<p>Photoshopの代わりに、ImageJでもできます。<code>Image</code>, <code>Adjust</code>, <code>Color Threshold</code>
基本的に数値入力です。つかいなれていないので、解説は省略します。</p>
<hr />
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            © 2021 Tajika Y, CC BY-NC
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.93c04032.min.js"></script>
      <script src="../../assets/javascripts/bundle.83e5331e.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: ['navigation.expand'],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>